<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Konten AI Harian</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .thread-card, .api-section, .generate-section, .image-prompt-section, .preview-section, .cta-manager-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease;
        }
        .thread-card:hover {
            transform: translateY(-5px);
        }
        /* Adjusted .thread-header to accommodate "Salin Semua" button */
        .thread-header {
            font-weight: 600;
            color: #343a40;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            display: flex; /* Ensure title and button are on one line */
            justify-content: space-between; /* Push button to the right */
            align-items: center; /* Vertically align items */
        }
        .prompt-item {
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e9ecef;
            position: relative;
        }
        .prompt-item:last-child {
            border-bottom: none;
        }
        .copy-btn {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            transition: color 0.2s;
        }
        .copy-btn:hover {
            color: #0d6efd;
        }
        .cta-section {
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        .status-active {
            background-color: #28a745;
        }
        .status-inactive {
            background-color: #dc3545;
        }
        .schedule-info {
            background-color: #e7f3ff;
            border-left: 4px solid #0d6efd;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
        }
        .loading-spinner {
            display: none;
            margin: 1rem auto;
            text-align: center;
        }
        .loading-spinner.active {
            display: block;
        }
        .thread-container {
            min-height: 300px;
        }
        .topic-selector, .output-format-selector {
            margin-bottom: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .topic-badge, .output-format-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background-color: #e9ecef;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .topic-badge:hover, .output-format-badge:hover {
            background-color: #0d6efd;
            color: white;
        }
        .topic-badge.active, .output-format-badge.active {
            background-color: #0d6efd;
            color: white;
        }

        /* Styles for CTA Manager */
        .cta-list-group {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .cta-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e9ecef;
        }
        .cta-list-item:last-child {
            border-bottom: none;
        }
        .cta-actions button {
            margin-left: 0.5rem;
        }

        /* Styles for Preview Section */
        .preview-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #fff;
        }
        .preview-header {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #333;
        }
        .preview-text {
            white-space: pre-wrap; /* Preserve line breaks */
            word-wrap: break-word; /* Break long words */
            font-size: 0.95rem;
        }

        /* Content Editable Styles */
        .editable-content:focus {
            outline: 2px solid #0d6efd;
            border-radius: 4px;
            padding: 2px;
            margin: -2px; /* Adjust margin to prevent layout shift */
        }
        .editable-content {
            display: inline-block; /* To allow outline around text */
            min-width: 10px; /* To make it clickable even if empty */
        }

        /* Spinner specific for prompts */
        .loading-text-spinner {
            display: inline-block;
            width: 1em;
            height: 1em;
            vertical-align: -0.125em;
            border: 0.1em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            -webkit-animation: .75s linear infinite spinner-border;
            animation: .75s linear infinite spinner-border;
        }
        @-webkit-keyframes spinner-border {
            to { -webkit-transform: rotate(360deg); transform: rotate(360deg); }
        }
        @keyframes spinner-border {
            to { -webkit-transform: rotate(360deg); transform: rotate(360deg); }
        }
        
        /* Styles for Image Prompts in main section and history */
        .image-prompt-item {
            background-color: #f1f3f5;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            position: relative;
            word-wrap: break-word; /* Ensure text wraps */
        }
        .image-prompt-item pre {
            white-space: pre-wrap; /* Preserve formatting but wrap */
            margin-bottom: 0;
            padding-right: 30px; /* Space for copy button */
        }
        .image-prompt-item .copy-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            transform: none; /* Override parent style */
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1 class="text-center">Generator Konten AI Harian</h1>
            <p class="text-center mb-0">Menghasilkan 3 thread tutorial AI unik setiap hari pukul 07.00 WIB</p>
        </div>
    </div>

    <div class="container">
        <div class="schedule-info">
            <div class="d-flex align-items-center">
                <i class="bi bi-clock-history me-2"></i>
                <div>
                    <strong>Jadwal Otomatis:</strong> Setiap hari pukul 07.00 WIB
                    <div class="small">Konten terakhir dihasilkan: <span id="lastGenerated">-</span></div>
                </div>
            </div>
        </div>

        <div class="api-section">
            <h4 class="mb-3">Pengaturan API Gemini 2.5 Flash</h4>
            <div class="row">
                <div class="col-md-8">
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="bi bi-key-fill me-2"></i>API Key</span>
                        <input type="password" id="apiKey" class="form-control" placeholder="Masukkan API Key Gemini Anda">
                        <button class="btn btn-primary" id="saveApiKey">Simpan</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <span class="status-indicator" id="apiStatus"></span>
                        <span id="apiStatusText">Status API: Tidak terhubung</span>
                    </div>
                </div>
            </div>
            <div class="form-text">
                Dapatkan API Key dari <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>
            </div>
        </div>

        <div class="generate-section">
            <h4 class="mb-3">Manajemen Persona</h4>
            <p class="text-muted">Simpan dan muat konfigurasi generator Anda untuk penggunaan berulang.</p>
            <div class="row align-items-end">
                <div class="col-lg-6 mb-3 mb-lg-0">
                    <label for="personaSelector" class="form-label fw-bold">Muat Persona</label>
                    <div class="input-group">
                        <select id="personaSelector" class="form-select">
                            <option value="">Pilih persona...</option>
                        </select>
                        <button id="loadPersonaBtn" class="btn btn-primary" title="Muat Persona"><i class="bi bi-box-arrow-down"></i> Muat</button>
                        <button id="deletePersonaBtn" class="btn btn-outline-danger" title="Hapus Persona Terpilih"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
                <div class="col-lg-6">
                    <label for="personaName" class="form-label fw-bold">Simpan Persona Baru</label>
                    <div class="input-group">
                        <input type="text" id="personaName" class="form-control" placeholder="Contoh: Blogger Teknologi">
                        <button id="savePersonaBtn" class="btn btn-success" title="Simpan Pengaturan Saat Ini"><i class="bi bi-save"></i> Simpan</button>
                    </div>
                </div>
            </div>
            <hr class="my-4">
            <h4 class="mt-4">Generate Konten AI Manual</h4>
            <p class="text-muted">Pilih preferensi dan klik tombol di bawah untuk generate konten baru secara manual</p>
            
            <div class="mb-4">
                <label for="topicSelector" class="form-label fw-bold">Pilih Topik Utama:</label>
                <div class="topic-selector" id="topicSelector">
                    <div class="topic-badge active" data-topic="umum">AI Umum</div>
                    <div class="topic-badge" data-topic="chatgpt">ChatGPT</div>
                    <div class="topic-badge" data-topic="gambar">AI Gambar</div>
                    <div class="topic-badge" data-topic="video">AI Video</div>
                    <div class="topic-badge" data-topic="bisnis">AI untuk Bisnis</div>
                    <div class="topic-badge" data-topic="pendidikan">AI untuk Pendidikan</div>
                    <div class="topic-badge" data-topic="teknologi">Teknologi Terbaru</div>
                    <div class="topic-badge" data-topic="kehidupan">Kehidupan Sehari-hari</div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-12">
                    <label for="specificKeywords" class="form-label fw-bold">Keyword Spesifik (Opsional):</label>
                    <input type="text" id="specificKeywords" class="form-control" placeholder="Contoh: 'optimasi SEO', 'tips belajar cepat'">
                    <div class="form-text">Masukkan kata kunci tambahan untuk topik yang lebih fokus.</div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6 mb-3 mb-md-0">
                    <label for="toneStyle" class="form-label fw-bold">Gaya Bahasa & Tone:</label>
                    <select id="toneStyle" class="form-select">
                        <option value="informatif">Informatif & Formal</option>
                        <option value="santai">Santai & Kekinian</option>
                        <option value="motivasi">Motivasi & Inspiratif</option>
                        <option value="humor">Humor & Lucu</option>
                        <option value="profesional">Profesional & Bisnis</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="languageSelector" class="form-label fw-bold">Bahasa Output:</label>
                    <select id="languageSelector" class="form-select">
                        <option value="Indonesian">Bahasa Indonesia (Default)</option>
                        <option value="English">English</option>
                        <option value="Spanish">Español (Spanish)</option>
                        <option value="Japanese">日本語 (Japanese)</option>
                        <option value="Arabic">العربية (Arabic)</option>
                        <option value="French">Français (French)</option>
                        <option value="German">Deutsch (German)</option>
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6 mb-3 mb-md-0">
                    <label for="numThreads" class="form-label fw-bold">Jumlah Konten yang Dihasilkan:</label>
                    <input type="number" id="numThreads" class="form-control" value="3" min="1" max="5">
                    <div class="form-text">Antara 1 sampai 5 konten (thread/outline/caption).</div>
                </div>
                <div class="col-md-6">
                    <label for="targetAudience" class="form-label fw-bold">Target Audiens:</label>
                    <select id="targetAudience" class="form-select">
                        <option value="umum">Masyarakat Umum</option>
                        <option value="pemula">Pemula/Awam</option>
                        <option value="mahasiswa">Mahasiswa/Pelajar</option>
                        <option value="pebisnis">Pebisnis UKM/Freelancer</option>
                        <option value="profesional">Profesional/Ahli</option>
                        <option value="developer">Developer/Programmer</option>
                    </select>
                </div>
            </div>

            <div class="mb-4">
                <label for="outputFormat" class="form-label fw-bold">Pilih Format Output:</label>
                <div class="output-format-selector" id="outputFormat">
                    <div class="output-format-badge active" data-format="thread">Thread Media Sosial</div>
                    <div class="output-format-badge" data-format="blog-outline">Outline Blog Post</div>
                    <div class="output-format-badge" data-format="caption">Caption Singkat</div>
                </div>
            </div>

            <button id="showCtaManagerBtn" class="btn btn-outline-info mb-3 w-100" type="button" data-bs-toggle="collapse" data-bs-target="#ctaManagerCollapse" aria-expanded="false" aria-controls="ctaManagerCollapse">
                <i class="bi bi-gear-fill me-2"></i> Manajemen Call-to-Action (CTA) Kustom
            </button>
            <div class="collapse mb-4 cta-manager-section" id="ctaManagerCollapse">
                <h5 class="mb-3">Daftar CTA Kustom Anda</h5>
                <div class="input-group mb-3">
                    <textarea id="newCtaText" class="form-control" placeholder="Masukkan teks CTA baru (contoh: Kunjungi website kami di...)"></textarea>
                    <button class="btn btn-success" id="addCtaBtn"><i class="bi bi-plus-lg"></i> Tambah CTA</button>
                </div>
                <div id="ctaList" class="cta-list-group">
                    <!-- Custom CTAs will be loaded here -->
                </div>
                <div class="mt-3">
                    <label class="form-label fw-bold">Pilih CTA untuk Digunakan:</label>
                    <select id="selectedCta" class="form-select">
                        <option value="default">Gunakan CTA Default (yang sudah ada)</option>
                        <!-- Custom CTAs will be added here -->
                    </select>
                </div>
            </div>

            <button id="generateBtn" class="btn btn-primary btn-lg w-100">
                <i class="bi bi-magic me-2"></i>Generate Konten Sekarang
            </button>
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2" id="loadingMessage">Sedang menghasilkan konten...</p>
            </div>
        </div>

        <div class="image-prompt-section" id="imagePromptSection" style="display: none;">
            <h4 class="mb-3">Prompt untuk AI Gambar</h4>
            <div class="alert alert-info" role="alert">
                Gunakan prompt di bawah ini di tool AI Gambar favorit Anda (contoh: Midjourney, DALL-E, Stable Diffusion) untuk menghasilkan visual yang relevan dengan konten Anda.
            </div>
            <div id="generatedImagePromptsContainer">
                <!-- Multiple image prompts will be loaded here if format is 'thread' or 'caption' -->
                <!-- Otherwise, a single prompt will appear here -->
            </div>
        </div>

        <div class="preview-section" id="previewSection" style="display: none;">
            <h4 class="mb-3">Pratinjau Posting</h4>
            <div class="alert alert-info" role="alert">
                Ini adalah perkiraan bagaimana konten Anda akan terlihat di platform media sosial.
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="preview-box">
                        <div class="preview-header"><i class="bi bi-twitter-x me-1"></i> Twitter / X Preview</div>
                        <div id="twitterPreview" class="preview-text"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="preview-box">
                        <div class="preview-header"><i class="bi bi-instagram me-1"></i> Instagram Preview</div>
                        <div id="instagramPreview" class="preview-text"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <h3 class="mb-4 d-flex justify-content-between align-items-center">
                    Konten AI Hari Ini
                    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#historyModal"><i class="bi bi-clock-history me-2"></i> Lihat Riwayat</button>
                </h3>
                <div id="threadsContainer" class="thread-container">
                    <!-- Thread akan dimuat di sini -->
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="historyModalLabel">Riwayat Generasi Konten</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="historyContent">
                    <!-- History threads will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-danger" id="clearHistoryBtn"><i class="bi bi-trash me-2"></i> Bersihkan Riwayat</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container">
        <div id="copyToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Berhasil Disalin</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Teks telah disalin ke clipboard
            </div>
        </div>
        <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-danger text-white">
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="errorMessage">
                Terjadi kesalahan saat menghasilkan konten
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Global Variables ---
            let selectedTopic = 'umum';
            let selectedOutputFormat = 'thread';
            let customCTAs = [];
            let generatedContentHistory = [];
            let personas = {};

            const promptTemplates = {
                'Indonesian': {
                    thread: `Buat {numThreads} thread unik berupa teks saja (tanpa em-dash maupun emoji), dengan gaya bahasa {tone} dan target audiens {audience}. Topik utamanya adalah {topic}{keywordPhrase}.\n\nSetiap thread harus:\n1. Diawali dengan kalimat hook yang menarik.\n2. Berisi 7 tips, tutorial, atau cara praktis.\n3. Setiap tips diawali dengan bullet point (•) dan tidak terlalu panjang.\n\nFormat respons JSON:\n{\n    "threads": [\n        {\n            "hook": "Kalimat hook yang menarik",\n            "prompts": ["Tips 1", "Tips 2", ...]\n        }\n    ]\n}\n\nPastikan respons dalam format JSON yang valid dan mudah diparse.`,
                    blog_outline: `Buat outline (kerangka) blog post yang detail dan komprehensif, dengan gaya bahasa {tone} untuk audiens {audience}. Topiknya adalah "{topic}"{keywordPhrase}.\n\nOutline harus mencakup:\n- Judul yang menarik\n- Pendahuluan (dengan hook)\n- Beberapa poin utama (dengan sub-poin jika perlu)\n- Kesimpulan (dengan Call-to-Action)\n\nFormat respons JSON:\n{\n    "outline": "Judul Blog Post: [Judul Anda]..."\n}\n\nGunakan format teks polos dengan baris baru (\\n) untuk setiap poin. Pastikan respons dalam format JSON yang valid.`,
                    caption: `Buat {numThreads} caption media sosial yang singkat dan menarik, dengan gaya bahasa {tone} dan target audiens {audience}. Topiknya adalah "{topic}"{keywordPhrase}.\n\nSetiap caption harus:\n1. Maksimal 150 kata.\n2. Mengandung satu atau dua kalimat pembuka yang menarik.\n3. Beberapa poin singkat atau ajakan bertindak.\n4. Menggunakan maksimal 5 hashtag yang relevan.\n5. Tanpa emoji atau em-dash.\n\nFormat respons JSON:\n{\n    "captions": ["Caption 1", "Caption 2", ...]\n}\n\nPastikan respons dalam format JSON yang valid.`
                },
                'English': {
                    thread: `Create {numThreads} unique text-only threads (no em-dashes or emojis), in a {tone} style for a {audience} audience. The main topic is {topic}{keywordPhrase}.\n\nEach thread must:\n1. Start with a compelling hook sentence.\n2. Contain 7 practical tips, tutorials, or methods.\n3. Each tip must start with a bullet point (•) and be concise.\n\nJSON response format:\n{\n    "threads": [\n        {\n            "hook": "A compelling hook sentence",\n            "prompts": ["Tip 1", "Tip 2", ...]\n        }\n    ]\n}\n\nEnsure the response is a valid, parsable JSON.`,
                    blog_outline: `Create a detailed and comprehensive blog post outline, in a {tone} style for a {audience} audience. The topic is "{topic}"{keywordPhrase}.\n\nThe outline must include:\n- A catchy title\n- An introduction (with a hook)\n- Several main points (with sub-points if necessary)\n- A conclusion (with a Call-to-Action)\n\nJSON response format:\n{\n    "outline": "Blog Post Title: [Your Title]..."\n}\n\nUse plain text with newlines (\\n) for each point. Ensure the response is a valid JSON.`,
                    caption: `Create {numThreads} short and engaging social media captions, in a {tone} style for a {audience} audience. The topic is "{topic}"{keywordPhrase}.\n\nEach caption must:\n1. Be a maximum of 150 words.\n2. Contain one or two interesting opening sentences.\n3. Include a few brief points or a call to action.\n4. Use a maximum of 5 relevant hashtags.\n5. No emojis or em-dashes.\n\nJSON response format:\n{\n    "captions": ["Caption 1", "Caption 2", ...]\n}\n\nEnsure the response is a valid JSON.`
                },
                'Spanish': {
                    thread: `Crea {numThreads} hilos de texto únicos (sin guiones largos ni emojis), en un estilo {tone} para una audiencia de {audience}. El tema principal es {topic}{keywordPhrase}.\n\nCada hilo debe:\n1. Empezar con una frase de gancho convincente.\n2. Contener 7 consejos prácticos, tutoriales o métodos.\n3. Cada consejo debe comenzar con un punto (•) y ser conciso.\n\nFormato de respuesta JSON:\n{\n    "threads": [\n        {\n            "hook": "Una frase de gancho convincente",\n            "prompts": ["Consejo 1", "Consejo 2", ...]\n        }\n    ]\n}\n\nAsegúrate de que la respuesta sea un JSON válido y analizable.`,
                    blog_outline: `Crea un esquema de publicación de blog detallado y completo, en un estilo {tone} para una audiencia de {audience}. El tema es "{topic}"{keywordPhrase}.\n\nEl esquema debe incluir:\n- Un título atractivo\n- Una introducción (con un gancho)\n- Varios puntos principales (con subpuntos si es necesario)\n- Una conclusión (con una llamada a la acción)\n\nFormato de respuesta JSON:\n{\n    "outline": "Título de la Publicación: [Tu Título]..."\n}\n\nUsa texto sin formato con saltos de línea (\\n) para cada punto. Asegúrate de que la respuesta sea un JSON válido.`,
                    caption: `Crea {numThreads} leyendas de redes sociales cortas y atractivas, en un estilo {tone} para una audiencia de {audience}. El tema es "{topic}"{keywordPhrase}.\n\nCada leyenda debe:\n1. Tener un máximo de 150 palabras.\n2. Contener una o dos frases de apertura interesantes.\n3. Incluir algunos puntos breves o una llamada a la acción.\n4. Usar un máximo de 5 hashtags relevantes.\n5. Sin emojis ni guiones largos.\n\nFormato de respuesta JSON:\n{\n    "captions": ["Leyenda 1", "Leyenda 2", ...]\n}\n\nAsegúrate de que la respuesta sea un JSON válido.`
                }
                // Other languages can be added here following the same structure.
            };

            // --- UI Elements Cache ---
            const apiKeyInput = document.getElementById('apiKey');
            const saveApiKeyBtn = document.getElementById('saveApiKey');
            const apiStatusIndicator = document.getElementById('apiStatus');
            const apiStatusText = document.getElementById('apiStatusText');
            const lastGeneratedSpan = document.getElementById('lastGenerated');
            const generateBtn = document.getElementById('generateBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const loadingMessage = document.getElementById('loadingMessage');
            const threadsContainer = document.getElementById('threadsContainer');
            const topicBadges = document.querySelectorAll('.topic-badge');
            const outputFormatBadges = document.querySelectorAll('.output-format-badge');
            const specificKeywordsInput = document.getElementById('specificKeywords');
            const toneStyleSelect = document.getElementById('toneStyle');
            const numThreadsInput = document.getElementById('numThreads'); // Updated ID
            const targetAudienceSelect = document.getElementById('targetAudience');
            const newCtaTextarea = document.getElementById('newCtaText');
            const addCtaBtn = document.getElementById('addCtaBtn');
            const ctaListDiv = document.getElementById('ctaList');
            const selectedCtaSelect = document.getElementById('selectedCta');
            const imagePromptSection = document.getElementById('imagePromptSection');
            const generatedImagePromptsContainer = document.getElementById('generatedImagePromptsContainer'); // Changed from single textarea
            const previewSection = document.getElementById('previewSection');
            const twitterPreviewDiv = document.getElementById('twitterPreview');
            const instagramPreviewDiv = document.getElementById('instagramPreview');
            const historyContentDiv = document.getElementById('historyContent');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            const personaNameInput = document.getElementById('personaName');
            const savePersonaBtn = document.getElementById('savePersonaBtn');
            const personaSelector = document.getElementById('personaSelector');
            const loadPersonaBtn = document.getElementById('loadPersonaBtn');
            const deletePersonaBtn = document.getElementById('deletePersonaBtn');
            const languageSelector = document.getElementById('languageSelector');


            // --- Initialization ---
            loadApiKey();
            loadCustomCTAs();
            loadGeneratedHistory();
            loadPersonas();
            renderCustomCTAs(); // Initial render for CTA list and dropdown
            renderPersonas();
            updateApiStatus(localStorage.getItem('geminiApiKey') !== null);
            // Load sample threads on page load, respecting initial input values
            generateSampleThreads(selectedTopic, null, selectedOutputFormat, parseInt(numThreadsInput.value) || 3);

            // --- Event Listeners ---
            saveApiKeyBtn.addEventListener('click', saveApiKey);
            generateBtn.addEventListener('click', handleGenerateClick);
            clearHistoryBtn.addEventListener('click', clearHistory);

            topicBadges.forEach(badge => {
                badge.addEventListener('click', function() {
                    topicBadges.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedTopic = this.getAttribute('data-topic');
                });
            });

            outputFormatBadges.forEach(badge => {
                badge.addEventListener('click', function() {
                    outputFormatBadges.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedOutputFormat = this.getAttribute('data-format');
                });
            });

            addCtaBtn.addEventListener('click', addCustomCta);
            ctaListDiv.addEventListener('click', handleCtaListActions); // Delegate events for edit/delete buttons
            savePersonaBtn.addEventListener('click', saveCurrentPersona);
            loadPersonaBtn.addEventListener('click', loadSelectedPersona);
            deletePersonaBtn.addEventListener('click', deleteSelectedPersona);

            // --- Persona Management ---
            function loadPersonas() {
                const savedPersonas = localStorage.getItem('personas');
                if (savedPersonas) {
                    personas = JSON.parse(savedPersonas);
                }
            }

            function savePersonas() {
                localStorage.setItem('personas', JSON.stringify(personas));
            }

            function renderPersonas() {
                personaSelector.innerHTML = '<option value="">Pilih persona...</option>';
                for (const name in personas) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    personaSelector.appendChild(option);
                }
            }

            function saveCurrentPersona() {
                const name = personaNameInput.value.trim();
                if (!name) {
                    showError('Nama persona tidak boleh kosong.');
                    return;
                }
                if (personas[name]) {
                    if (!confirm(`Persona dengan nama "${name}" sudah ada. Anda yakin ingin menimpanya?`)) {
                        return;
                    }
                }

                personas[name] = {
                    topic: selectedTopic,
                    keywords: specificKeywordsInput.value,
                    tone: toneStyleSelect.value,
                    numThreads: numThreadsInput.value,
                    audience: targetAudienceSelect.value,
                    outputFormat: selectedOutputFormat,
                    cta: selectedCtaSelect.value,
                    language: languageSelector.value
                };

                savePersonas();
                renderPersonas();
                personaNameInput.value = '';
                showToast(`Persona "${name}" berhasil disimpan.`);
            }

            function loadSelectedPersona() {
                const name = personaSelector.value;
                if (!name) {
                    showError('Silakan pilih persona untuk dimuat.');
                    return;
                }
                const persona = personas[name];

                // Update Topic
                topicBadges.forEach(b => {
                    if (b.getAttribute('data-topic') === persona.topic) {
                        b.classList.add('active');
                        selectedTopic = persona.topic;
                    } else {
                        b.classList.remove('active');
                    }
                });

                // Update Output Format
                outputFormatBadges.forEach(b => {
                    if (b.getAttribute('data-format') === persona.outputFormat) {
                        b.classList.add('active');
                        selectedOutputFormat = persona.outputFormat;
                    } else {
                        b.classList.remove('active');
                    }
                });

                // Update other fields
                specificKeywordsInput.value = persona.keywords;
                toneStyleSelect.value = persona.tone;
                numThreadsInput.value = persona.numThreads;
                targetAudienceSelect.value = persona.audience;
                selectedCtaSelect.value = persona.cta;
                languageSelector.value = persona.language || 'Indonesian'; // Fallback for older personas

                showToast(`Persona "${name}" berhasil dimuat.`);
            }

            function deleteSelectedPersona() {
                const name = personaSelector.value;
                if (!name) {
                    showError('Silakan pilih persona untuk dihapus.');
                    return;
                }
                if (confirm(`Anda yakin ingin menghapus persona "${name}"?`)) {
                    delete personas[name];
                    savePersonas();
                    renderPersonas();
                    showToast(`Persona "${name}" berhasil dihapus.`);
                }
            }

            // --- Content Analysis ---
            function analyzeText(text, keywordsStr) {
                if (!text) {
                    return { wordCount: 0, sentenceCount: 0, charCount: 0, avgSentenceLength: 0, keywordAnalysis: [] };
                }

                const words = text.match(/\b(\w+)\b/g) || [];
                const sentences = text.split(/[.!?]+/).filter(Boolean);
                const charCount = text.length;
                const wordCount = words.length;
                const sentenceCount = sentences.length > 0 ? sentences.length : 1;
                const avgSentenceLength = (wordCount / sentenceCount).toFixed(1);

                const keywordAnalysis = [];
                if (keywordsStr) {
                    const keywords = keywordsStr.split(',').map(k => k.trim().toLowerCase()).filter(Boolean);
                    const textLower = text.toLowerCase();
                    keywords.forEach(keyword => {
                        const regex = new RegExp('\\b' + keyword + '\\b', 'gi');
                        const count = (text.match(regex) || []).length;
                        const density = wordCount > 0 ? ((count / wordCount) * 100).toFixed(2) : 0;
                        keywordAnalysis.push({ keyword, count, density });
                    });
                }

                return { wordCount, sentenceCount, charCount, avgSentenceLength, keywordAnalysis };
            }

            function createAnalysisElement(analysisData) {
                const analysisContainer = document.createElement('div');
                analysisContainer.className = 'analysis-section mt-3 p-3';
                analysisContainer.style.backgroundColor = '#f8f9fa';
                analysisContainer.style.borderRadius = '8px';
                analysisContainer.style.display = 'none'; // Initially hidden

                let keywordHtml = '<h6>Analisis Kata Kunci</h6>';
                if (analysisData.keywordAnalysis.length > 0) {
                    keywordHtml += '<ul class="list-unstyled mb-0">';
                    analysisData.keywordAnalysis.forEach(kw => {
                        keywordHtml += `<li><strong>"${kw.keyword}":</strong> Ditemukan ${kw.count} kali (Kepadatan: ${kw.density}%)</li>`;
                    });
                    keywordHtml += '</ul>';
                } else {
                    keywordHtml += '<p class="text-muted small mb-0">Tidak ada kata kunci spesifik yang dimasukkan untuk dianalisis.</p>';
                }

                analysisContainer.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Statistik Teks</h6>
                            <ul class="list-unstyled mb-3 mb-md-0 small">
                                <li><strong>Jumlah Karakter:</strong> ${analysisData.charCount}</li>
                                <li><strong>Jumlah Kata:</strong> ${analysisData.wordCount}</li>
                                <li><strong>Jumlah Kalimat:</strong> ${analysisData.sentenceCount}</li>
                                <li><strong>Rata-rata Kata/Kalimat:</strong> ${analysisData.avgSentenceLength}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            ${keywordHtml}
                        </div>
                    </div>
                `;
                return analysisContainer;
            }

            // --- API Key Management ---
            function loadApiKey() {
                const savedApiKey = localStorage.getItem('geminiApiKey');
                if (savedApiKey) {
                    apiKeyInput.value = savedApiKey;
                }
            }

            function saveApiKey() {
                const apiKey = apiKeyInput.value.trim();
                if (apiKey !== '') {
                    localStorage.setItem('geminiApiKey', apiKey);
                    updateApiStatus(true);
                    showToast('API Key berhasil disimpan');
                } else {
                    localStorage.removeItem('geminiApiKey');
                    updateApiStatus(false);
                    showError('API Key tidak boleh kosong');
                }
            }

            function updateApiStatus(isConnected) {
                if (isConnected) {
                    apiStatusIndicator.classList.add('status-active');
                    apiStatusIndicator.classList.remove('status-inactive');
                    apiStatusText.textContent = 'Status API: Terhubung';
                } else {
                    apiStatusIndicator.classList.add('status-inactive');
                    apiStatusIndicator.classList.remove('status-active');
                    apiStatusText.textContent = 'Status API: Tidak terhubung';
                }
            }

            // --- Toast Notifications ---
            function showToast(message, type = 'success') {
                const toastElement = document.getElementById('copyToast');
                const toastHeader = toastElement.querySelector('.toast-header');
                const toastBody = toastElement.querySelector('.toast-body');

                toastBody.textContent = message;
                toastHeader.className = 'toast-header'; // Reset classes
                if (type === 'success') {
                    toastHeader.classList.add('bg-success', 'text-white');
                } else if (type === 'warning') {
                    toastHeader.classList.add('bg-warning', 'text-dark');
                } else if (type === 'danger') {
                    toastHeader.classList.add('bg-danger', 'text-white');
                } else {
                    toastHeader.classList.add('bg-primary', 'text-white');
                }

                const toast = new bootstrap.Toast(toastElement);
                toast.show();
            }

            function showError(message) {
                const toastElement = document.getElementById('errorToast');
                document.getElementById('errorMessage').textContent = message;
                const toast = new bootstrap.Toast(toastElement);
                toast.show();
            }

            // --- Copy to Clipboard ---
            function copyToClipboard(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showToast('Teks berhasil disalin');
                    } else {
                        showToast('Gagal menyalin teks', 'danger');
                    }
                } catch (err) {
                    showToast('Gagal menyalin teks', 'danger');
                    console.error('Gagal menyalin: ', err);
                } finally {
                    document.body.removeChild(textarea);
                }
            }

            // --- Export and Action Buttons ---
            function downloadContent(text, filename) {
                const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function createActionButtons(contentData, ctaText, format, baseFilename) {
                const btnGroup = document.createElement('div');
                btnGroup.className = 'btn-group';

                const formatContent = (asMarkdown) => {
                    let text = '';
                    let fullTextToCopy = '';
                    if (format === 'thread') {
                        const hook = contentData.hook;
                        const prompts = contentData.prompts;
                        fullTextToCopy = `${hook}\n\n${prompts.join('\n')}\n\n${ctaText}`;
                        if (asMarkdown) {
                            text = `## ${hook}\n\n`;
                            prompts.forEach(p => { text += `${p}\n`; });
                            text += `\n**CTA:**\n${ctaText}`;
                        } else {
                            text = fullTextToCopy;
                        }
                    } else if (format === 'blog-outline') {
                        text = contentData.outline;
                        if (asMarkdown) {
                            text = text
                                .replace(/^Judul Blog Post:\s*(.*)/gm, '# $1')
                                .replace(/(\n[IVX]+\.)/g, '\n##')
                                .replace(/(\n\s+[A-Z]\.)/g, '\n*');
                        }
                    } else if (format === 'caption') {
                        text = contentData; // contentData is just the caption string
                    }
                    return { text, fullTextToCopy };
                };

                // Copy All Button
                const copyAllBtn = document.createElement('button');
                copyAllBtn.className = 'btn btn-sm btn-outline-secondary';
                copyAllBtn.innerHTML = '<i class="bi bi-clipboard me-1"></i> Salin Semua';
                copyAllBtn.addEventListener('click', () => {
                    const { text, fullTextToCopy } = formatContent(false);
                    copyToClipboard(fullTextToCopy || text);
                });

                // Dropdown Toggle
                const dropdownToggle = document.createElement('button');
                dropdownToggle.type = 'button';
                dropdownToggle.className = 'btn btn-sm btn-outline-secondary dropdown-toggle dropdown-toggle-split';
                dropdownToggle.setAttribute('data-bs-toggle', 'dropdown');
                dropdownToggle.setAttribute('aria-expanded', 'false');
                dropdownToggle.innerHTML = '<span class="visually-hidden">Toggle Dropdown</span>';

                // Dropdown Menu
                const dropdownMenu = document.createElement('ul');
                dropdownMenu.className = 'dropdown-menu';

                const san_fname = baseFilename.replace(/[^a-z0-9]/gi, '_').toLowerCase();

                // Export TXT
                const exportTxtLi = document.createElement('li');
                const exportTxtLink = document.createElement('a');
                exportTxtLink.className = 'dropdown-item';
                exportTxtLink.href = '#';
                exportTxtLink.textContent = 'Ekspor sebagai .txt';
                exportTxtLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    const { text } = formatContent(false);
                    downloadContent(text, `${san_fname}.txt`);
                });
                exportTxtLi.appendChild(exportTxtLink);

                // Export MD
                const exportMdLi = document.createElement('li');
                const exportMdLink = document.createElement('a');
                exportMdLink.className = 'dropdown-item';
                exportMdLink.href = '#';
                exportMdLink.textContent = 'Ekspor sebagai .md';
                exportMdLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    const { text } = formatContent(true);
                    downloadContent(text, `${san_fname}.md`);
                });
                exportMdLi.appendChild(exportMdLink);

                dropdownMenu.appendChild(exportTxtLi);
                dropdownMenu.appendChild(exportMdLi);

                btnGroup.appendChild(copyAllBtn);
                btnGroup.appendChild(dropdownToggle);
                btnGroup.appendChild(dropdownMenu);

                return btnGroup;
            }

            // --- Custom CTA Management ---
            function loadCustomCTAs() {
                const savedCTAs = localStorage.getItem('customCTAs');
                if (savedCTAs) {
                    customCTAs = JSON.parse(savedCTAs);
                }
            }

            function saveCustomCTAs() {
                localStorage.setItem('customCTAs', JSON.stringify(customCTAs));
                renderCustomCTAs();
            }

            function renderCustomCTAs() {
                ctaListDiv.innerHTML = '';
                selectedCtaSelect.innerHTML = '<option value="default">Gunakan CTA Default (yang sudah ada)</option>';

                if (customCTAs.length === 0) {
                    ctaListDiv.innerHTML = '<div class="p-3 text-muted">Belum ada CTA kustom yang disimpan.</div>';
                }

                customCTAs.forEach((cta, index) => {
                    // Render in CTA list manager
                    const ctaItem = document.createElement('div');
                    ctaItem.className = 'cta-list-item';
                    ctaItem.innerHTML = `
                        <span class="cta-text flex-grow-1 me-2">${cta}</span>
                        <div class="cta-actions">
                            <button class="btn btn-sm btn-outline-info edit-cta-btn" data-index="${index}"><i class="bi bi-pencil-fill"></i></button>
                            <button class="btn btn-sm btn-outline-danger delete-cta-btn" data-index="${index}"><i class="bi bi-trash-fill"></i></button>
                        </div>
                    `;
                    ctaListDiv.appendChild(ctaItem);

                    // Add to select dropdown
                    const option = document.createElement('option');
                    option.value = cta;
                    option.textContent = cta;
                    selectedCtaSelect.appendChild(option);
                });
            }

            function addCustomCta() {
                const ctaText = newCtaTextarea.value.trim();
                if (ctaText) {
                    customCTAs.push(ctaText);
                    saveCustomCTAs();
                    newCtaTextarea.value = '';
                    showToast('CTA kustom berhasil ditambahkan');
                } else {
                    showError('Teks CTA tidak boleh kosong');
                }
            }

            function handleCtaListActions(event) {
                const target = event.target;
                const index = target.closest('button')?.dataset.index;

                if (index === undefined) return;

                if (target.classList.contains('delete-cta-btn') || target.parentElement.classList.contains('delete-cta-btn')) {
                    if (confirm('Anda yakin ingin menghapus CTA ini?')) {
                        customCTAs.splice(index, 1);
                        saveCustomCTAs();
                        showToast('CTA kustom berhasil dihapus');
                    }
                } else if (target.classList.contains('edit-cta-btn') || target.parentElement.classList.contains('edit-cta-btn')) {
                    const currentText = customCTAs[index];
                    const newText = prompt('Edit teks CTA:', currentText);
                    if (newText !== null && newText.trim() !== '') {
                        customCTAs[index] = newText.trim();
                        saveCustomCTAs();
                        showToast('CTA kustom berhasil diperbarui');
                    } else if (newText !== null) {
                        showError('Teks CTA tidak boleh kosong');
                    }
                }
            }

            // --- History Management ---
            function loadGeneratedHistory() {
                const savedHistory = localStorage.getItem('generatedContentHistory');
                if (savedHistory) {
                    generatedContentHistory = JSON.parse(savedHistory);
                }
            }

            function saveGeneratedHistory() {
                localStorage.setItem('generatedContentHistory', JSON.stringify(generatedContentHistory));
            }

            function renderHistoryModal() {
                historyContentDiv.innerHTML = '';
                if (generatedContentHistory.length === 0) {
                    historyContentDiv.innerHTML = '<p class="text-center text-muted">Belum ada riwayat generasi konten.</p>';
                    return;
                }
                
                generatedContentHistory.slice().reverse().forEach((record, idx) => { // Reverse to show latest first
                    const historyCard = document.createElement('div');
                    historyCard.className = 'thread-card'; // Reuse thread-card style
                    historyCard.style.marginBottom = '1rem';
                    
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'thread-header small text-muted mb-2';
                    dateHeader.textContent = `Generated: ${new Date(record.date).toLocaleString('id-ID')} | Topik: ${record.topic} | Format: ${record.format}`;
                    
                    historyCard.appendChild(dateHeader);

                    if (record.format === 'thread') {
                        record.content.threads.forEach((thread, index) => {
                            const threadElement = createThread(thread, index, true, record.cta); // true for history, disable editing
                            const innerHeader = threadElement.querySelector('.thread-header');
                            if(innerHeader) innerHeader.textContent = `Thread ${index + 1}`;
                            historyCard.appendChild(threadElement);
                        });
                    } else if (record.format === 'blog-outline') {
                        const contentDiv = document.createElement('div');
                        contentDiv.innerHTML = `
                            <h6 class="mb-2">Outline Blog Post:</h6>
                            <div class="prompt-item">
                                <span class="editable-content">${record.content.outline.replace(/\n/g, '<br>')}</span>
                                <button class="copy-btn" onclick="copyToClipboard(this.previousElementSibling.innerText)"><i class="bi bi-clipboard"></i></button>
                            </div>
                        `;
                        historyCard.appendChild(contentDiv);
                    } else if (record.format === 'caption') {
                        // Handle multiple captions in history
                        if (record.content.captions && record.content.captions.length > 0) {
                            record.content.captions.forEach((caption, index) => {
                                const contentDiv = document.createElement('div');
                                contentDiv.innerHTML = `
                                    <h6 class="mb-2">Caption Singkat ${index + 1}:</h6>
                                    <div class="prompt-item">
                                        <span class="editable-content">${caption.replace(/\n/g, '<br>')}</span>
                                        <button class="copy-btn" onclick="copyToClipboard(this.previousElementSibling.innerText)"><i class="bi bi-clipboard"></i></button>
                                    </div>
                                `;
                                historyCard.appendChild(contentDiv);
                            });
                        }
                    }

                    // Add image prompt(s) if available
                    if (record.imagePrompts && record.imagePrompts.length > 0) {
                        const imgPromptContainer = document.createElement('div');
                        imgPromptContainer.className = 'cta-section mt-3'; // Reuse cta-section style
                        imgPromptContainer.innerHTML = `<p class="mb-1"><strong>Prompt Gambar AI:</strong></p>`;
                        
                        record.imagePrompts.forEach((imgPrompt, imgIdx) => {
                            const imgPromptDiv = document.createElement('div');
                            imgPromptDiv.className = 'image-prompt-item';
                            imgPromptDiv.innerHTML = `
                                <pre>${imgPrompt}</pre>
                                <button class="copy-btn" onclick="copyToClipboard(this.previousElementSibling.innerText)"><i class="bi bi-clipboard"></i></button>
                            `;
                            imgPromptContainer.appendChild(imgPromptDiv);
                        });
                        historyCard.appendChild(imgPromptContainer);
                    }
                    
                    historyContentDiv.appendChild(historyCard);
                });
            }

            function clearHistory() {
                if (confirm('Anda yakin ingin menghapus semua riwayat generasi konten?')) {
                    generatedContentHistory = [];
                    saveGeneratedHistory();
                    renderHistoryModal();
                    showToast('Riwayat berhasil dibersihkan');
                }
            }

            // Listen for modal show event to render history
            const historyModal = document.getElementById('historyModal');
            historyModal.addEventListener('show.bs.modal', renderHistoryModal);

            // --- Content Generation (Main Logic) ---
            async function handleGenerateClick() {
                const apiKey = localStorage.getItem('geminiApiKey');
                if (!apiKey) {
                    showError('Silakan masukkan API Key terlebih dahulu');
                    return;
                }
                
                // Collect all parameters
                const params = {
                    topic: selectedTopic,
                    keywords: specificKeywordsInput.value.trim(),
                    tone: toneStyleSelect.value,
                    numThreads: parseInt(numThreadsInput.value) || 3, // Use numThreadsInput
                    audience: targetAudienceSelect.value,
                    outputFormat: selectedOutputFormat,
                    customCta: selectedCtaSelect.value === 'default' ? null : selectedCtaSelect.value,
                    language: languageSelector.value
                };
                
                await generateContentWithAPI(apiKey, params);
            }

            function updateLoadingMessage(message) {
                loadingMessage.innerHTML = `<div class="loading-text-spinner me-2"></div> ${message}`;
            }

            async function generateContentWithAPI(apiKey, params) {
                // Clear previous results
                threadsContainer.innerHTML = '';
                generatedImagePromptsContainer.innerHTML = ''; // Clear image prompts too
                imagePromptSection.style.display = 'none';
                previewSection.style.display = 'none';

                // Show loading state
                loadingSpinner.classList.add('active');
                generateBtn.disabled = true;
                updateLoadingMessage('Sedang menyiapkan permintaan...');
                
                let actualCtaText = selectedCtaSelect.value === 'default' ? `PS: Saya juga buka kelas AI untuk kamu yang benar-benar awam!\nKeunggulannya: setiap hari ada postingan tutorial terbaru, update terus.\nBelajar bisa kapan saja mulai jam 08.00 sampai 00.00 WIB.\nBebas belajar sampai bisa, sistem bayar per 10 hari.\nDan yang paling penting, harganya terjangkau dan disesuaikan.\nLangsung klik: https://lynk.id/vdmax` : params.customCta;

                let prompt = '';
                let contentDataForHistory = {}; // To store the parsed content data

                // Dynamic prompt construction based on format and other parameters
                switch(params.outputFormat) {
                    case 'thread':
                        prompt = buildThreadPrompt(params);
                        break;
                    case 'blog-outline':
                        prompt = buildBlogOutlinePrompt(params);
                        break;
                    case 'caption':
                        prompt = buildCaptionPrompt(params);
                        break;
                    default:
                        prompt = buildThreadPrompt(params); // Fallback to thread
                }

                try {
                    updateLoadingMessage('Mengirim permintaan ke Gemini...');
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }]
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
                    }

                    updateLoadingMessage('Menganalisis respons dari AI...');
                    const data = await response.json();
                    const responseText = data.candidates[0].content.parts[0].text;
                    
                    // Extract JSON from response
                    let jsonMatch = responseText.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('Format respons tidak valid atau tidak ditemukan JSON.');
                    }
                    
                    const generatedData = JSON.parse(jsonMatch[0]);
                    contentDataForHistory = generatedData; // Store for history

                    let allImagePrompts = [];
                    let previewMainContent = '';
                    let previewPrompts = []; // Used specifically for thread previews

                    // Render based on output format
                    if (params.outputFormat === 'thread') {
                        if (generatedData.threads && generatedData.threads.length > 0) {
                            generatedData.threads.forEach((thread, index) => {
                                const threadElement = createThread(thread, index, false, actualCtaText);
                                threadsContainer.appendChild(threadElement);
                                allImagePrompts.push(buildImagePromptFromContent(thread.hook, params.topic, params.keywords, 'thread'));
                            });
                            previewMainContent = generatedData.threads[0].hook;
                            previewPrompts = generatedData.threads[0].prompts;
                        } else {
                             throw new Error('Tidak ada thread yang dihasilkan.');
                        }
                    } else if (params.outputFormat === 'blog-outline') {
                        if (generatedData.outline) {
                            const card = document.createElement('div');
                            card.className = 'thread-card';

                            const header = document.createElement('h4');
                            header.className = 'mb-3 d-flex justify-content-between align-items-center';
                            header.textContent = 'Outline Blog Post';

                            const controlsDiv = document.createElement('div');
                            controlsDiv.className = 'd-flex align-items-center';

                            const actionButtons = createActionButtons(generatedData, null, 'blog-outline', `outline-${selectedTopic}`);
                            controlsDiv.appendChild(actionButtons);

                            const analysisBtn = document.createElement('button');
                            analysisBtn.className = 'btn btn-sm btn-outline-info ms-2';
                            analysisBtn.innerHTML = '<i class="bi bi-bar-chart-line-fill"></i>';
                            analysisBtn.title = 'Tampilkan Analisis';
                            controlsDiv.appendChild(analysisBtn);
                            header.appendChild(controlsDiv);

                            const content = document.createElement('div');
                            content.className = 'prompt-item editable-content';
                            content.setAttribute('contenteditable', 'true');
                            content.innerHTML = generatedData.outline.replace(/\n/g, '<br>');

                            const analysisData = analyzeText(generatedData.outline, specificKeywordsInput.value);
                            const analysisElement = createAnalysisElement(analysisData);
                            analysisBtn.addEventListener('click', () => {
                                analysisElement.style.display = analysisElement.style.display === 'none' ? 'block' : 'none';
                            });

                            card.appendChild(header);
                            card.appendChild(content);
                            card.appendChild(analysisElement);
                            threadsContainer.appendChild(card);

                            previewMainContent = generatedData.outline;
                            allImagePrompts.push(buildImagePromptFromContent(generatedData.outline, params.topic, params.keywords, 'blog-outline'));
                        } else {
                            throw new Error('Tidak ada outline blog yang dihasilkan.');
                        }
                    } else if (params.outputFormat === 'caption') {
                        if (generatedData.captions && generatedData.captions.length > 0) {
                            generatedData.captions.forEach((caption, index) => {
                                const card = document.createElement('div');
                                card.className = 'thread-card';

                                const header = document.createElement('h4');
                                header.className = 'mb-3 d-flex justify-content-between align-items-center';
                                header.textContent = `Caption Singkat ${index + 1}`;

                                const controlsDiv = document.createElement('div');
                                controlsDiv.className = 'd-flex align-items-center';

                                const actionButtons = createActionButtons(caption, null, 'caption', `caption-${index + 1}-${selectedTopic}`);
                                controlsDiv.appendChild(actionButtons);

                                const analysisBtn = document.createElement('button');
                                analysisBtn.className = 'btn btn-sm btn-outline-info ms-2';
                                analysisBtn.innerHTML = '<i class="bi bi-bar-chart-line-fill"></i>';
                                analysisBtn.title = 'Tampilkan Analisis';
                                controlsDiv.appendChild(analysisBtn);
                                header.appendChild(controlsDiv);

                                const content = document.createElement('div');
                                content.className = 'prompt-item editable-content';
                                content.setAttribute('contenteditable', 'true');
                                content.innerHTML = caption.replace(/\n/g, '<br>');

                                const analysisData = analyzeText(caption, specificKeywordsInput.value);
                                const analysisElement = createAnalysisElement(analysisData);
                                analysisBtn.addEventListener('click', () => {
                                    analysisElement.style.display = analysisElement.style.display === 'none' ? 'block' : 'none';
                                });

                                card.appendChild(header);
                                card.appendChild(content);
                                card.appendChild(analysisElement);
                                threadsContainer.appendChild(card);

                                allImagePrompts.push(buildImagePromptFromContent(caption, params.topic, params.keywords, 'caption'));
                            });
                            previewMainContent = generatedData.captions[0]; // Show first caption in preview
                        } else {
                            throw new Error('Tidak ada caption yang dihasilkan.');
                        }
                    }

                    // Display image prompt section
                    generatedImagePromptsContainer.innerHTML = ''; // Clear previous
                    allImagePrompts.forEach(imgPrompt => {
                        const promptItemDiv = document.createElement('div');
                        promptItemDiv.className = 'image-prompt-item';
                        
                        const promptPre = document.createElement('pre');
                        promptPre.textContent = imgPrompt;

                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'copy-btn';
                        copyBtn.innerHTML = '<i class="bi bi-clipboard"></i>';
                        copyBtn.addEventListener('click', function() {
                            copyToClipboard(imgPrompt);
                        });

                        promptItemDiv.appendChild(promptPre);
                        promptItemDiv.appendChild(copyBtn);
                        generatedImagePromptsContainer.appendChild(promptItemDiv);
                    });
                    imagePromptSection.style.display = 'block';

                    // Render posting preview
                    renderPostingPreview(previewMainContent, previewPrompts, actualCtaText, params.outputFormat);

                    // Update last generated time
                    const now = new Date();
                    lastGeneratedSpan.textContent = now.toLocaleString('id-ID');
                    
                    showToast('Konten berhasil dihasilkan!');

                    // Add to history
                    generatedContentHistory.push({
                        date: now.toISOString(),
                        topic: params.topic,
                        format: params.outputFormat,
                        content: contentDataForHistory, // Store the full generated content
                        imagePrompts: allImagePrompts, // Store all generated image prompts
                        cta: actualCtaText
                    });
                    saveGeneratedHistory();
                    
                } catch (error) {
                    console.error('Error:', error);
                    showError(`Gagal menghasilkan konten: ${error.message}. Coba lagi atau sesuaikan prompt.`);
                    
                    // Fallback to sample threads if error, based on selected format/topic and numThreads
                    generateSampleThreads(params.topic, actualCtaText, params.outputFormat, params.numThreads);
                } finally {
                    // Sembunyikan loading state
                    loadingSpinner.classList.remove('active');
                    generateBtn.disabled = false;
                }
            }

            // --- Prompt Builders ---
            function buildThreadPrompt(params) {
                const { topic, keywords, tone, numThreads, audience, language } = params;
                const keywordPhrase = keywords ? ` tentang "${keywords}"` : '';
                const audiencePhrase = audience !== 'umum' ? ` untuk ${audience}` : '';
                
                const template = promptTemplates[language]?.thread || promptTemplates['English'].thread;

                return template
                    .replace(/{numThreads}/g, numThreads)
                    .replace(/{tone}/g, tone)
                    .replace(/{audience}/g, audiencePhrase)
                    .replace(/{topic}/g, topic)
                    .replace(/{keywordPhrase}/g, keywordPhrase);
            }

            function buildBlogOutlinePrompt(params) {
                const { topic, keywords, tone, audience, language } = params;
                const keywordPhrase = keywords ? ` dengan fokus "${keywords}"` : '';
                const audiencePhrase = audience !== 'umum' ? ` untuk audiens ${audience}` : '';

                const template = promptTemplates[language]?.blog_outline || promptTemplates['English'].blog_outline;

                return template
                    .replace(/{tone}/g, tone)
                    .replace(/{audience}/g, audiencePhrase)
                    .replace(/{topic}/g, topic)
                    .replace(/{keywordPhrase}/g, keywordPhrase);
            }

            function buildCaptionPrompt(params) {
                const { topic, keywords, tone, numThreads, audience, language } = params;
                const keywordPhrase = keywords ? ` terkait "${keywords}"` : '';
                const audiencePhrase = audience !== 'umum' ? ` untuk audiens ${audience}` : '';

                const template = promptTemplates[language]?.caption || promptTemplates['English'].caption;

                return template
                    .replace(/{numThreads}/g, numThreads)
                    .replace(/{tone}/g, tone)
                    .replace(/{audience}/g, audiencePhrase)
                    .replace(/{topic}/g, topic)
                    .replace(/{keywordPhrase}/g, keywordPhrase);
            }

            // --- Thread / Content Rendering ---
            function createThread(threadData, index, isHistory = false, ctaText = null) {
                const threadCard = document.createElement('div');
                threadCard.className = 'thread-card';
                
                const header = document.createElement('div');
                header.className = 'thread-header';
                
                const headerTitle = document.createElement('span');
                headerTitle.textContent = `Thread ${index + 1}`;
                header.appendChild(headerTitle);

                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'd-flex align-items-center';

                if (!isHistory) {
                    const actionButtons = createActionButtons(
                        threadData,
                        ctaText,
                        'thread',
                        `thread-${index + 1}-${selectedTopic}`
                    );
                    controlsDiv.appendChild(actionButtons);

                    const analysisBtn = document.createElement('button');
                    analysisBtn.className = 'btn btn-sm btn-outline-info ms-2';
                    analysisBtn.innerHTML = '<i class="bi bi-bar-chart-line-fill"></i>';
                    analysisBtn.title = 'Tampilkan Analisis';
                    controlsDiv.appendChild(analysisBtn);

                    const fullText = `${threadData.hook}\n\n${threadData.prompts.join('\n')}\n\n${ctaText}`;
                    const analysisData = analyzeText(fullText, specificKeywordsInput.value);
                    const analysisElement = createAnalysisElement(analysisData);
                    threadCard.appendChild(analysisElement);

                    analysisBtn.addEventListener('click', () => {
                        analysisElement.style.display = analysisElement.style.display === 'none' ? 'block' : 'none';
                    });
                }
                header.appendChild(controlsDiv);


                const hook = document.createElement('div');
                hook.className = 'prompt-item';
                
                const hookText = document.createElement('span');
                hookText.className = 'editable-content';
                hookText.textContent = threadData.hook;
                if (!isHistory) { // Enable editing only for current generation
                    hookText.setAttribute('contenteditable', 'true');
                }
                
                const hookCopyBtn = document.createElement('button');
                hookCopyBtn.className = 'copy-btn';
                hookCopyBtn.innerHTML = '<i class="bi bi-clipboard"></i>';
                hookCopyBtn.addEventListener('click', function() {
                    copyToClipboard(hookText.innerText);
                });
                
                hook.appendChild(hookText);
                hook.appendChild(hookCopyBtn);
                
                const promptsContainer = document.createElement('div');
                
                threadData.prompts.forEach(prompt => {
                    const promptItem = document.createElement('div');
                    promptItem.className = 'prompt-item';
                    
                    const promptText = document.createElement('span');
                    promptText.className = 'editable-content';
                    promptText.textContent = `${prompt}`; // AI already provides bullet points, no need to add here
                    if (!isHistory) { // Enable editing only for current generation
                        promptText.setAttribute('contenteditable', 'true');
                    }
                    
                    const promptCopyBtn = document.createElement('button');
                    promptCopyBtn.className = 'copy-btn';
                    promptCopyBtn.innerHTML = '<i class="bi bi-clipboard"></i>';
                    promptCopyBtn.addEventListener('click', function() {
                        copyToClipboard(promptText.innerText);
                    });
                    
                    promptItem.appendChild(promptText);
                    promptItem.appendChild(promptCopyBtn);
                    promptsContainer.appendChild(promptItem);
                });
                
                const ctaSection = document.createElement('div');
                ctaSection.className = 'cta-section';
                
                const ctaDisplay = ctaText.replace(/\n/g, '<br>'); // Use the plain text CTA, convert newlines for HTML display

                const ctaTextElement = document.createElement('div');
                ctaTextElement.innerHTML = ctaDisplay;
                
                const ctaCopyBtn = document.createElement('button');
                ctaCopyBtn.className = 'btn btn-sm btn-outline-primary';
                ctaCopyBtn.innerHTML = '<i class="bi bi-clipboard me-1"></i> Salin CTA';
                ctaCopyBtn.addEventListener('click', function() {
                    copyToClipboard(ctaText); // Copy the original plain text CTA
                });
                
                const ctaContainer = document.createElement('div');
                ctaContainer.className = 'd-flex justify-content-between align-items-center';
                ctaContainer.appendChild(ctaTextElement);
                if (!isHistory) { // Only show CTA copy button for current generation (it's part of 'Salin Semua' in history)
                    ctaContainer.appendChild(ctaCopyBtn);
                }
                
                ctaSection.appendChild(ctaContainer);
                
                threadCard.appendChild(header);
                threadCard.appendChild(hook);
                threadCard.appendChild(promptsContainer);
                threadCard.appendChild(ctaSection);
                
                return threadCard;
            }

            // --- Image Prompt Generation ---
            function buildImagePromptFromContent(content, topic, keywords, format = 'thread') {
                let mainTextForImage = '';
                let visualThemeModifier = '';
                let specificTextOverlay = ''; // For text hardcoded for a specific topic (e.g., 'PEMBELAJARAN JARAK JAUH')

                // 1. Get a concise and representative core text
                // Prioritize the hook/title/first sentence as they are designed to summarize
                if (format === 'thread') {
                    // Start with the full hook, then refine it
                    mainTextForImage = content.trim(); 
                    
                    // Specific phrases for better image text
                    if (mainTextForImage.toLowerCase().includes('mengoptimalkan produktivitas di tempat kerja')) {
                        mainTextForImage = 'Optimalisasi Produktivitas Kerja';
                    } else if (mainTextForImage.toLowerCase().includes('pemanfaatan video yang efektif')) {
                        mainTextForImage = 'Video Komunikasi Profesional';
                    } else if (mainTextForImage.toLowerCase().includes('rahasia ai gambar')) {
                        mainTextForImage = 'Rahasia AI Gambar';
                    } else if (mainTextForImage.toLowerCase().includes('manfaatkan chatgpt')) {
                        mainTextForImage = 'Manfaatkan ChatGPT';
                    } else if (mainTextForImage.toLowerCase().includes('tingkatkan potensi ai')) {
                        mainTextForImage = 'Tingkatkan Potensi AI';
                    } else {
                        // Fallback: If no specific phrase, try to get the first sentence or a few words
                        let firstSentenceMatch = mainTextForImage.match(/^([^.!?]+[.!?])/);
                        if (firstSentenceMatch) {
                            mainTextForImage = firstSentenceMatch[1].trim();
                        } else {
                            mainTextForImage = mainTextForImage.split(' ').slice(0, 7).join(' ').trim(); // Take up to 7 words
                        }
                    }

                    // Ensure text is clean and doesn't contain bullet points if it accidentally got one
                    mainTextForImage = mainTextForImage.replace(/^•\s*/, '').replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").replace(/\s{2,}/g," ").trim();
                    
                    // Max length for image text for thread hook (can be slightly longer)
                    const maxImageTextLength = 60; 
                    if (mainTextForImage.length > maxImageTextLength) {
                        let tempText = mainTextForImage.substring(0, maxImageTextLength);
                        let lastSpaceIndex = tempText.lastIndexOf(' ');
                        if (lastSpaceIndex !== -1 && lastSpaceIndex > maxImageTextLength / 2) {
                            mainTextForImage = tempText.substring(0, lastSpaceIndex);
                        } else {
                            mainTextForImage = tempText;
                        }
                        mainTextForImage += '...';
                    }
                    visualThemeModifier = `Menggambarkan ide inti dari konten tentang ${topic} dengan fokus pada "${mainTextForImage}".`;

                } else if (format === 'blog-outline') {
                    const titleMatch = content.match(/^Judul Blog Post:\s*([^\n]+)/);
                    mainTextForImage = titleMatch ? titleMatch[1].trim() : (content.split('\n')[0] || '').replace('Judul Blog Post:', '').trim();
                    
                    const maxImageTextLength = 70; // A bit longer for blog titles
                    if (mainTextForImage.length > maxImageTextLength) {
                        let tempText = mainTextForImage.substring(0, maxImageTextLength);
                        let lastSpaceIndex = tempText.lastIndexOf(' ');
                        if (lastSpaceIndex !== -1 && lastSpaceIndex > maxImageTextLength / 2) {
                            mainTextForImage = tempText.substring(0, lastSpaceIndex);
                        } else {
                            mainTextForImage = tempText;
                        }
                        mainTextForImage += '...';
                    }
                    mainTextForImage = mainTextForImage.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").replace(/\s{2,}/g," ").trim();
                    visualThemeModifier = `Menyampaikan konsep utama dari outline berjudul: "${mainTextForImage}".`;

                } else if (format === 'caption') {
                    mainTextForImage = content.split('. ')[0].replace(/^•\s*/, '').trim(); 
                    
                    const maxImageTextLength = 45; // Shortest for captions
                    if (mainTextForImage.length > maxImageTextLength) {
                        let tempText = mainTextForImage.substring(0, maxImageTextLength);
                        let lastSpaceIndex = tempText.lastIndexOf(' ');
                        if (lastSpaceIndex !== -1 && lastSpaceIndex > maxImageTextLength / 2) {
                            mainTextForImage = tempText.substring(0, lastSpaceIndex);
                        } else {
                            mainTextForImage = tempText;
                        }
                        mainTextForImage += '...';
                    }
                    mainTextForImage = mainTextForImage.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").replace(/\s{2,}/g," ").trim();
                    visualThemeModifier = `Mengilustrasikan pesan kunci dari caption: "${mainTextForImage}".`;
                }

                // 2. Define base visual style, dynamic based on topic
                let baseVisualDescription = `A digital illustration with glowing interconnected lines and abstract data streams. The scene features diverse people (adults, young adults, children if relevant to topic) actively engaged with technology.`;

                switch (topic) {
                    case 'pendidikan':
                        baseVisualDescription = `A vibrant, futuristic, and digital illustration. The scene features diverse people (adults and children) actively engaged with glowing laptops, tablets, and smartphones, surrounded by interconnected blue and pink digital lines, circuit patterns, and abstract data streams, symbolizing technology and connectivity in education.`;
                        specificTextOverlay = `'PEMBELAJARAN JARAK JAUH'`; // This text only for education topic
                        break;
                    case 'bisnis':
                        baseVisualDescription = `A sleek, modern digital illustration. Professionals collaborating around a holographic interface, charts, and data visualizations, with abstract business growth elements and network connections. The atmosphere is professional and innovative.`;
                        break;
                    case 'chatgpt':
                        baseVisualDescription = `A clean, minimalist digital illustration. People interacting with AI chatbots on screens, represented by glowing text bubbles and abstract thought processes, in a futuristic or smart environment. Focus on clear interface and communication.`;
                        break;
                    case 'gambar':
                        baseVisualDescription = `An imaginative digital illustration. People creating art or designs on tablets/laptops, surrounded by flowing digital brushstrokes, evolving shapes, and abstract artistic elements, reflecting AI's role in creative processes. The mood is creative and inspiring.`;
                        break;
                    case 'video':
                        baseVisualDescription = `A dynamic digital illustration. People producing, editing, or watching videos on various devices, with glowing video frames, playback controls, and abstract soundwave or visual effect elements. The scene conveys movement and digital media.`;
                        break;
                    case 'teknologi':
                        baseVisualDescription = `A futuristic digital landscape. People interacting with advanced gadgets, smart devices, and holographic displays, surrounded by complex circuit boards, neural networks, and evolving technological concepts. The mood is cutting-edge and transformative.`;
                        break;
                    case 'kehidupan':
                        baseVisualDescription = `A warm, inviting digital illustration. People using AI in daily life, e.g., smart home, personal assistant, health tracking, seamlessly integrated into a comfortable, modern living space. The atmosphere is convenient and comforting.`;
                        break;
                    default: // umum
                        baseVisualDescription = `A dynamic digital illustration. People interacting with various forms of AI and technology in everyday scenarios, surrounded by abstract data flows and interconnected digital elements. The overall feel is about modern living with technology.`;
                        break;
                }

                let styleDescription = '';
                switch(toneStyleSelect.value) {
                    case 'santai': styleDescription = 'a vibrant, friendly, and approachable cartoon style'; break;
                    case 'motivasi': styleDescription = 'an inspiring, cinematic, and bright style'; break;
                    case 'humor': styleDescription = 'a humorous, quirky, and playful illustration style'; break;
                    case 'profesional': styleDescription = 'a sleek, modern, and professional corporate style'; break;
                    default: styleDescription = 'a clear, modern, and informative graphic design style'; break;
                }
                
                // Combine text for image overlay
                let textOverlayPrompt = "";
                if (specificTextOverlay) {
                    textOverlayPrompt = `Include the exact text ${specificTextOverlay} prominently displayed in the image, integrated subtly into the digital elements or as a holographic projection.`;
                } else if (mainTextForImage) {
                    // Use UPPERCASE and 'bold' to instruct AI to render clearly
                    textOverlayPrompt = `Subtly integrate the bold text '${mainTextForImage.toUpperCase()}' within the digital interface or as an abstract holographic overlay.`;
                }

                // Final Prompt
                return `${baseVisualDescription} ${visualThemeModifier} ${textOverlayPrompt} Overall mood: innovative, educational, and accessible. Style: ${styleDescription}. --ar 16:9 --v 5.2 --q 2`;
            }


            // --- Posting Preview ---
            function renderPostingPreview(mainContent, prompts = [], cta, format) {
                previewSection.style.display = 'block';
                
                let twitterText = '';
                let instagramText = '';
                let cleanedCta = cta; // cta parameter here should already be the plain text version

                if (format === 'thread') {
                    twitterText = `${mainContent}\n\n`;
                    prompts.forEach(p => twitterText += `${p}\n`);
                    twitterText += `\n${cleanedCta}\n\n#AI #TipsAI #Tutorial`;

                    instagramText = `*${mainContent}*\n\n`;
                    prompts.forEach(p => instagramText += `${p.replace('• ', '')}\n`);
                    instagramText += `\n${cleanedCta}\n\n#AI #Tips #Productivity`;
                } else if (format === 'blog-outline') {
                    const blogTitleMatch = mainContent.match(/^Judul Blog Post:\s*([^\n]+)/);
                    const blogTitle = blogTitleMatch ? blogTitleMatch[1].trim() : (mainContent.split('\n')[0] || '').replace('Judul Blog Post:', '').trim();
                    const blogIntro = mainContent.split('\n')[2] ? mainContent.split('\n')[2].replace('I. Pendahuluan', '').trim() : '';

                    twitterText = `Artikel Baru: ${blogTitle}\n\nBaca outline lengkapnya untuk memahami struktur mendalam.\n\n${cleanedCta}\n\n#BlogAI #KontenAI`;
                    instagramText = `*${blogTitle}*\n\n${blogIntro}\n\nLihat struktur lengkapnya untuk panduan menulis Anda!\n\n${cleanedCta}\n\n#Blog #Outline #AIWriting`;
                } else if (format === 'caption') {
                    // Assuming mainContent is a single caption text
                    twitterText = mainContent;
                    instagramText = mainContent; // Instagram handles hashtags better natively
                }

                // Trim to typical character limits for preview
                twitterPreviewDiv.textContent = twitterText.substring(0, 500) + (twitterText.length > 500 ? '...' : '');
                instagramPreviewDiv.textContent = instagramText.substring(0, 1000) + (instagramText.length > 1000 ? '...' : '');
            }

            // --- Sample Threads (Fallback) ---
            function generateSampleThreads(topic, ctaText, outputFormat = 'thread', numContents = 3) {
                let threads = []; // This will hold content regardless of format (threads, outlines, captions)
                let ctaUsed = ctaText || `PS: Saya juga buka kelas AI untuk kamu yang benar-benar awam!\nKeunggulannya: setiap hari ada postingan tutorial terbaru, update terus.\nBelajar bisa kapan saja mulai jam 08.00 sampai 00.00 WIB.\nBebas belajar sampai bisa, sistem bayar per 10 hari.\nDan yang paling penting, harganya terjangkau dan disesuaikan.\nLangsung klik: https://lynk.id/vdmax`;
                
                let sampleImagePrompts = [];
                let previewMainContent = '';
                let previewPrompts = []; // For thread type only

                // Clear containers first
                threadsContainer.innerHTML = '';
                generatedImagePromptsContainer.innerHTML = '';
                imagePromptSection.style.display = 'none';
                previewSection.style.display = 'none';

                if (outputFormat === 'thread') {
                    const allSampleThreads = {
                        'chatgpt': [
                            {
                                hook: "Lebih dari sekadar menjawab pertanyaan: ChatGPT sebagai asisten pribadi.",
                                prompts: [
                                    "• Optimalkan prompt Anda untuk hasil yang lebih presisi.",
                                    "• Manfaatkan fitur 'custom instructions' untuk gaya respons konsisten.",
                                    "• Gunakan ChatGPT untuk brainstorming ide dan konten.",
                                    "• Buat draf email atau laporan profesional dalam hitungan detik.",
                                    "• Simulasikan percakapan untuk latihan presentasi atau wawancara.",
                                    "• Terjemahkan teks antar bahasa dengan cepat dan akurat.",
                                    "• Ringkas dokumen panjang menjadi poin-poin kunci yang mudah dipahami."
                                ]
                            },
                            {
                                hook: "Cara ChatGPT membantu bisnis kecil berkembang pesat dan hemat biaya.",
                                prompts: [
                                    "• Otomatiskan layanan pelanggan dengan chatbot berbasis ChatGPT.",
                                    "• Hasilkan ide kampanye pemasaran yang menarik dan orisinal.",
                                    "• Tulis deskripsi produk yang menjual dan menarik perhatian.",
                                    "• Analisis tren pasar dan kompetitor secara efisien.",
                                    "• Buat konten media sosial yang konsisten dan relevan.",
                                    "• Susun rencana bisnis dan proposal proyek dengan cepat.",
                                    "• Lakukan riset pasar awal tanpa biaya besar."
                                ]
                            },
                            {
                                hook: "Kerja ChatGPT untuk kreator konten: Tingkatkan kualitas dan kecepatan produksi.",
                                prompts: [
                                    "• Hasilkan ide-ide unik untuk video atau blog post.",
                                    "• Buat outline konten yang terstruktur dan mudah diikuti.",
                                    "• Tulis skrip podcast atau narasi video yang engaging.",
                                    "• Kembangkan karakter atau alur cerita fiksi.",
                                    "• Optimalkan judul dan deskripsi untuk SEO.",
                                    "• Buat caption media sosial yang memikat audiens.",
                                    "• Dapatkan feedback instan tentang draf tulisan Anda."
                                ]
                            }
                        ],
                        'umum': [
                            {
                                hook: "Ponsel pintar Anda mulai terasa lambat dan kurang responsif?",
                                prompts: [
                                    "• Hapus aplikasi yang tidak terpakai secara rutin untuk membebaskan ruang penyimpanan.",
                                    "• Bersihkan cache aplikasi secara berkala melalui pengaturan ponsel Anda.",
                                    "• Nonaktifkan fitur sinkronisasi otomatis untuk aplikasi yang tidak esensial.",
                                    "• Hindari penggunaan banyak widget di layar utama yang dapat memakan sumber daya.",
                                    "• Perbarui sistem operasi dan aplikasi Anda ke versi terbaru untuk perbaikan kinerja."
                                ]
                            },
                            {
                                hook: "Sering merasa baterai HP cepat habis dan performa menurun?",
                                prompts: [
                                    "• Kurangi kecerahan layar dan aktifkan mode hemat daya.",
                                    "• Tutup aplikasi yang berjalan di latar belakang saat tidak digunakan.",
                                    "• Nonaktifkan lokasi, Bluetooth, dan Wi-Fi jika tidak diperlukan.",
                                    "• Hindari paparan suhu ekstrem yang dapat merusak baterai.",
                                    "• Gunakan pengisi daya original atau berkualitas tinggi.",
                                    "• Lakukan restart ponsel secara berkala untuk menyegarkan sistem."
                                ]
                            },
                            {
                                hook: "Optimalkan pengalaman digital Anda dengan tips penggunaan internet yang aman dan efisien.",
                                prompts: [
                                    "• Gunakan password yang kuat dan unik untuk setiap akun online Anda.",
                                    "• Aktifkan Two-Factor Authentication (2FA) di semua layanan penting.",
                                    "• Berhati-hati dengan tautan mencurigakan dan email phising.",
                                    "• Perbarui browser dan software keamanan Anda secara teratur.",
                                    "• Gunakan VPN saat terhubung ke Wi-Fi publik untuk privasi.",
                                    "• Rutin periksa izin aplikasi di ponsel Anda.",
                                    "• Pahami kebijakan privasi layanan online yang Anda gunakan."
                                ]
                            }
                        ],
                        'video': [
                            {
                                hook: "Pemanfaatan video yang efektif kini menjadi tulang punggung strategi komunikasi profesional. Kuasai produksinya untuk dampak maksimal.",
                                prompts: [
                                    "• Rencanakan naskah dengan jelas dan tentukan tujuan video Anda.",
                                    "• Perhatikan kualitas audio dan visual agar video terlihat profesional.",
                                    "• Gunakan pencahayaan yang memadai dan latar belakang yang rapi.",
                                    "• Edit video dengan transisi yang halus dan musik latar yang sesuai.",
                                    "• Optimalkan durasi video agar tetap menarik dan tidak membosankan.",
                                    "• Sertakan ajakan bertindak (CTA) yang jelas di akhir video.",
                                    "• Promosikan video Anda di berbagai platform untuk jangkauan luas."
                                ]
                            },
                            {
                                hook: "AI mengubah cara kita membuat dan mengedit video. Otomatiskan prosesnya untuk efisiensi luar biasa!",
                                prompts: [
                                    "• Manfaatkan AI untuk menghasilkan naskah video secara otomatis.",
                                    "• Gunakan tool AI untuk memotong klip dan menyusun timeline.",
                                    "• AI dapat membantu menambahkan subtitle dan terjemahan instan.",
                                    "• Jelajahi fitur AI untuk koreksi warna dan peningkatan kualitas gambar.",
                                    "• Otomatiskan pemilihan musik latar yang sesuai dengan suasana video.",
                                    "• Pelajari cara AI mengenali objek dan wajah untuk efek otomatis.",
                                    "• Gunakan AI untuk membuat highlight reel dari rekaman panjang."
                                ]
                            }
                        ],
                        'gambar': [
                            {
                                hook: "Rahasia AI Gambar: Ciptakan visual menakjubkan dengan prompt yang tepat dan teknik optimasi.",
                                prompts: [
                                    "• Mulai dengan deskripsi objek atau subjek utama secara jelas.",
                                    "• Tentukan gaya seni yang Anda inginkan (misal: 'futuristic', 'watercolor', 'oil painting').",
                                    "• Tambahkan detail pencahayaan dan suasana (misal: 'golden hour', 'neon city night').",
                                    "• Gunakan referensi seniman atau gaya visual tertentu (misal: 'in the style of Van Gogh').",
                                    "• Eksplorasi modifier untuk kualitas gambar (misal: '--ar 16:9', '--v 5.2', '--q 2').",
                                    "• Coba variasi prompt dengan kata kunci yang berbeda untuk hasil unik.",
                                    "• Jangan ragu untuk bereksperimen dengan prompt negatif (apa yang tidak diinginkan)."
                                ]
                            }
                        ],
                        // ... Tambahkan lebih banyak sample untuk topik 'bisnis', 'pendidikan', 'teknologi', 'kehidupan'
                    };
                    
                    const availableSamples = allSampleThreads[topic] || allSampleThreads['umum'];
                    threads = availableSamples.slice(0, numContents); // Use numContents here

                    threads.forEach((thread, index) => {
                        const threadElement = createThread(thread, index, false, ctaUsed);
                        threadsContainer.appendChild(threadElement);
                        // Use the revised buildImagePromptFromContent for samples too
                        sampleImagePrompts.push(buildImagePromptFromContent(thread.hook, topic, specificKeywordsInput.value.trim(), 'thread'));
                    });
                    if (threads.length > 0) {
                        previewMainContent = threads[0].hook;
                        previewPrompts = threads[0].prompts;
                    }

                } else if (outputFormat === 'blog-outline') {
                    // Sample outlines - will only show one, but can be expanded
                    const sampleOutlines = [
                        `Judul Blog Post: ${topic} dan Masa Depan Kita\n\nI. Pendahuluan\n   A. Apa itu ${topic} dan mengapa penting?\n   B. Gambaran singkat evolusi ${topic}\nII. Aplikasi ${topic} dalam Kehidupan Sehari-hari\n   A. Contoh di smartphone Anda\n   B. Di industri dan bisnis\nIII. Tantangan dan Etika ${topic}\n   A. Isu privasi data\n   B. Potensi bias AI\nIV. Masa Depan ${topic} dan Rekomendasi\n   A. Prediksi perkembangan ke depan\n   B. Cara beradaptasi dengan ${topic}\nV. Kesimpulan\n   A. Ringkasan poin kunci\n   B. Ajakan untuk eksplorasi lebih lanjut`,
                        `Judul Blog Post: Panduan Lengkap Memulai dengan ${topic}\n\nI. Pendahuluan: Mengapa ${topic}?\n   A. Pengertian dasar dan manfaatnya.\n   B. Target audiens dan tujuan blog.\nII. Langkah Awal Mempelajari ${topic}\n   A. Sumber belajar terbaik (kursus, buku, tutorial).\n   B. Konsep dasar yang harus dipahami.\nIII. Proyek Praktis Sederhana dengan ${topic}\n   A. Ide proyek untuk pemula.\n   B. Alat dan sumber daya yang dibutuhkan.\nIV. Menghindari Jebakan Umum dalam ${topic}\n   A. Kesalahan yang sering dilakukan pemula.\n   B. Tips mengatasi tantangan.\nV. Kesimpulan\n   A. Ringkasan poin penting.\n   B. Langkah selanjutnya untuk pendalaman.`
                    ];

                    const outlinesToDisplay = sampleOutlines.slice(0, numContents);
                    
                    outlinesToDisplay.forEach((outlineText, index) => {
                        const card = document.createElement('div');
                        card.className = 'thread-card mb-3';

                        const header = document.createElement('h4');
                        header.className = 'mb-3 d-flex justify-content-between align-items-center';
                        header.textContent = `Outline Blog Post ${index + 1}`;

                        const controlsDiv = document.createElement('div');
                        controlsDiv.className = 'd-flex align-items-center';

                        const actionButtons = createActionButtons({ outline: outlineText }, null, 'blog-outline', `sample-outline-${index + 1}-${topic}`);
                        controlsDiv.appendChild(actionButtons);

                        const analysisBtn = document.createElement('button');
                        analysisBtn.className = 'btn btn-sm btn-outline-info ms-2';
                        analysisBtn.innerHTML = '<i class="bi bi-bar-chart-line-fill"></i>';
                        analysisBtn.title = 'Tampilkan Analisis';
                        controlsDiv.appendChild(analysisBtn);
                        header.appendChild(controlsDiv);

                        const content = document.createElement('div');
                        content.className = 'prompt-item editable-content';
                        content.setAttribute('contenteditable', 'true');
                        content.innerHTML = outlineText.replace(/\n/g, '<br>');

                        const analysisData = analyzeText(outlineText, specificKeywordsInput.value);
                        const analysisElement = createAnalysisElement(analysisData);
                        analysisBtn.addEventListener('click', () => {
                            analysisElement.style.display = analysisElement.style.display === 'none' ? 'block' : 'none';
                        });

                        card.appendChild(header);
                        card.appendChild(content);
                        card.appendChild(analysisElement);
                        threadsContainer.appendChild(card);

                        if (index === 0) {
                            previewMainContent = outlineText;
                            sampleImagePrompts.push(buildImagePromptFromContent(outlineText, topic, specificKeywordsInput.value.trim(), 'blog-outline'));
                        }
                    });

                } else if (outputFormat === 'caption') {
                    const allSampleCaptions = [
                        `Kecerdasan Buatan mengubah segalanya! Mulai dari cara kita bekerja hingga berinteraksi. Jangan ketinggalan era ini, pelajari dasar-dasarnya sekarang!\n\n#AI #MasaDepan #Teknologi`,
                        `Bingung cara kerja AI? Yuk, intip 3 hal dasar yang wajib kamu tahu! Dijamin bikin kamu paham teknologi masa depan.\n\n#AIExplained #TechForLife #BelajarAI`,
                        `Siap untuk revolusi AI? Manfaatkan teknologi ini untuk produktivitas maksimal. Klik link di bio untuk panduan lengkap!\n\n#AIRevolution #ProductivityHacks #FutureIsNow`,
                        `AI itu bukan cuma robot! Dia ada di aplikasi favoritmu. Pelajari cara AI mempermudah hidupmu setiap hari.\n\n#AI #EverydayAI #Innovasi`,
                        `Peluang karir di dunia AI? Sangat besar! Siapkan dirimu dengan skill yang relevan. Masa depan ada di tanganmu.\n\n#AICareer #FutureSkills #TechJobs`
                    ];
                    
                    const captionsToDisplay = allSampleCaptions.slice(0, numContents); // Use numContents here

                    captionsToDisplay.forEach((caption, index) => {
                        const card = document.createElement('div');
                        card.className = 'thread-card';

                        const header = document.createElement('h4');
                        header.className = 'mb-3 d-flex justify-content-between align-items-center';
                        header.textContent = `Caption Singkat ${index + 1}`;

                        const controlsDiv = document.createElement('div');
                        controlsDiv.className = 'd-flex align-items-center';

                        const actionButtons = createActionButtons(caption, null, 'caption', `sample-caption-${index + 1}-${topic}`);
                        controlsDiv.appendChild(actionButtons);

                        const analysisBtn = document.createElement('button');
                        analysisBtn.className = 'btn btn-sm btn-outline-info ms-2';
                        analysisBtn.innerHTML = '<i class="bi bi-bar-chart-line-fill"></i>';
                        analysisBtn.title = 'Tampilkan Analisis';
                        controlsDiv.appendChild(analysisBtn);
                        header.appendChild(controlsDiv);

                        const content = document.createElement('div');
                        content.className = 'prompt-item editable-content';
                        content.setAttribute('contenteditable', 'true');
                        content.innerHTML = caption.replace(/\n/g, '<br>');

                        const analysisData = analyzeText(caption, specificKeywordsInput.value);
                        const analysisElement = createAnalysisElement(analysisData);
                        analysisBtn.addEventListener('click', () => {
                            analysisElement.style.display = analysisElement.style.display === 'none' ? 'block' : 'none';
                        });

                        card.appendChild(header);
                        card.appendChild(content);
                        card.appendChild(analysisElement);
                        threadsContainer.appendChild(card);

                        sampleImagePrompts.push(buildImagePromptFromContent(caption, topic, specificKeywordsInput.value.trim(), 'caption'));
                    });
                    if (captionsToDisplay.length > 0) {
                        previewMainContent = captionsToDisplay[0];
                    }
                }

                // Display sample image prompts
                generatedImagePromptsContainer.innerHTML = '';
                sampleImagePrompts.forEach(imgPrompt => {
                    const promptItemDiv = document.createElement('div');
                    promptItemDiv.className = 'image-prompt-item';
                    
                    const promptPre = document.createElement('pre');
                    promptPre.textContent = imgPrompt;

                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-btn';
                    copyBtn.innerHTML = '<i class="bi bi-clipboard"></i>';
                    copyBtn.addEventListener('click', function() {
                        copyToClipboard(imgPrompt);
                    });

                    promptItemDiv.appendChild(promptPre);
                    promptItemDiv.appendChild(copyBtn);
                    generatedImagePromptsContainer.appendChild(promptItemDiv);
                });
                imagePromptSection.style.display = 'block';

                renderPostingPreview(previewMainContent, previewPrompts, ctaUsed, outputFormat);

                lastGeneratedSpan.textContent = new Date().toLocaleString('id-ID') + ' (Sample)';
            }


            // Simulate daily thread generation (for actual use, this would be a backend cron job)
            function simulateDailyGeneration() {
                const now = new Date();
                // Check if it's 7 AM WIB (UTC+7, so hour 0-23)
                // In a real scenario, this would be on a server, not client-side.
                // This client-side check is primarily for demonstration purposes within this single file.
                if (now.getHours() === 7 && now.getMinutes() === 0) {
                    const apiKey = localStorage.getItem('geminiApiKey');
                    if (apiKey) {
                        const params = {
                            topic: selectedTopic,
                            keywords: '', // Daily gen might use broader keywords
                            tone: 'informatif',
                            numThreads: 3, // Default to 3 for automated generation
                            audience: 'umum',
                            outputFormat: 'thread',
                            customCta: null,
                        };
                        generateContentWithAPI(apiKey, params);
                    } else {
                        // Use default CTA text for sample generation
                        const defaultCta = `PS: Saya juga buka kelas AI untuk kamu yang benar-benar awam!\nKeunggulannya: setiap hari ada postingan tutorial terbaru, update terus.\nBelajar bisa kapan saja mulai jam 08.00 sampai 00.00 WIB.\nBebas belajar sampai bisa, sistem bayar per 10 hari.\nDan yang paling penting, harganya terjangkau dan disesuaikan.\nLangsung klik: https://lynk.id/vdmax`;
                        generateSampleThreads(selectedTopic, defaultCta, 'thread', 3);
                    }
                }
            }
            // setInterval(simulateDailyGeneration, 60000); // Commented out to avoid excessive sample regeneration during testing
        });
    </script>
</body>
</html>
