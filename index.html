<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Konten AI Harian</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .thread-card, .api-section, .generate-section, .image-prompt-section, .preview-section, .cta-manager-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease;
        }
        .thread-card:hover {
            transform: translateY(-5px);
        }
        .thread-header {
            font-weight: 600;
            color: #343a40;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        .prompt-item {
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e9ecef;
            position: relative;
        }
        .prompt-item:last-child {
            border-bottom: none;
        }
        .copy-btn {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            transition: color 0.2s;
        }
        .copy-btn:hover {
            color: #0d6efd;
        }
        .cta-section {
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        .status-active {
            background-color: #28a745;
        }
        .status-inactive {
            background-color: #dc3545;
        }
        .schedule-info {
            background-color: #e7f3ff;
            border-left: 4px solid #0d6efd;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
        }
        .loading-spinner {
            display: none;
            margin: 1rem auto;
            text-align: center;
        }
        .loading-spinner.active {
            display: block;
        }
        .thread-container {
            min-height: 300px;
        }
        .topic-selector, .output-format-selector {
            margin-bottom: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .topic-badge, .output-format-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background-color: #e9ecef;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .topic-badge:hover, .output-format-badge:hover {
            background-color: #0d6efd;
            color: white;
        }
        .topic-badge.active, .output-format-badge.active {
            background-color: #0d6efd;
            color: white;
        }

        /* Styles for CTA Manager */
        .cta-list-group {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .cta-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e9ecef;
        }
        .cta-list-item:last-child {
            border-bottom: none;
        }
        .cta-actions button {
            margin-left: 0.5rem;
        }

        /* Styles for Preview Section */
        .preview-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #fff;
        }
        .preview-header {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #333;
        }
        .preview-text {
            white-space: pre-wrap; /* Preserve line breaks */
            word-wrap: break-word; /* Break long words */
            font-size: 0.95rem;
        }

        /* Content Editable Styles */
        .editable-content:focus {
            outline: 2px solid #0d6efd;
            border-radius: 4px;
            padding: 2px;
            margin: -2px; /* Adjust margin to prevent layout shift */
        }
        .editable-content {
            display: inline-block; /* To allow outline around text */
            min-width: 10px; /* To make it clickable even if empty */
        }

        /* Spinner specific for prompts */
        .loading-text-spinner {
            display: inline-block;
            width: 1em;
            height: 1em;
            vertical-align: -0.125em;
            border: 0.1em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            -webkit-animation: .75s linear infinite spinner-border;
            animation: .75s linear infinite spinner-border;
        }
        @-webkit-keyframes spinner-border {
            to { -webkit-transform: rotate(360deg); transform: rotate(360deg); }
        }
        @keyframes spinner-border {
            to { -webkit-transform: rotate(360deg); transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1 class="text-center">Generator Konten AI Harian</h1>
            <p class="text-center mb-0">Menghasilkan 3 thread tutorial AI unik setiap hari pukul 07.00 WIB</p>
        </div>
    </div>

    <div class="container">
        <div class="schedule-info">
            <div class="d-flex align-items-center">
                <i class="bi bi-clock-history me-2"></i>
                <div>
                    <strong>Jadwal Otomatis:</strong> Setiap hari pukul 07.00 WIB
                    <div class="small">Konten terakhir dihasilkan: <span id="lastGenerated">-</span></div>
                </div>
            </div>
        </div>

        <div class="api-section">
            <h4 class="mb-3">Pengaturan API Gemini 2.5 Flash</h4>
            <div class="row">
                <div class="col-md-8">
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="bi bi-key-fill me-2"></i>API Key</span>
                        <input type="password" id="apiKey" class="form-control" placeholder="Masukkan API Key Gemini Anda">
                        <button class="btn btn-primary" id="saveApiKey">Simpan</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <span class="status-indicator" id="apiStatus"></span>
                        <span id="apiStatusText">Status API: Tidak terhubung</span>
                    </div>
                </div>
            </div>
            <div class="form-text">
                Dapatkan API Key dari <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>
            </div>
        </div>

        <div class="generate-section">
            <h4>Generate Konten AI Manual</h4>
            <p class="text-muted">Pilih preferensi dan klik tombol di bawah untuk generate konten baru secara manual</p>
            
            <div class="mb-4">
                <label for="topicSelector" class="form-label fw-bold">Pilih Topik Utama:</label>
                <div class="topic-selector" id="topicSelector">
                    <div class="topic-badge active" data-topic="umum">AI Umum</div>
                    <div class="topic-badge" data-topic="chatgpt">ChatGPT</div>
                    <div class="topic-badge" data-topic="gambar">AI Gambar</div>
                    <div class="topic-badge" data-topic="video">AI Video</div>
                    <div class="topic-badge" data-topic="bisnis">AI untuk Bisnis</div>
                    <div class="topic-badge" data-topic="pendidikan">AI untuk Pendidikan</div>
                    <div class="topic-badge" data-topic="teknologi">Teknologi Terbaru</div>
                    <div class="topic-badge" data-topic="kehidupan">Kehidupan Sehari-hari</div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6 mb-3 mb-md-0">
                    <label for="specificKeywords" class="form-label fw-bold">Keyword Spesifik (Opsional):</label>
                    <input type="text" id="specificKeywords" class="form-control" placeholder="Contoh: 'optimasi SEO', 'tips belajar cepat'">
                    <div class="form-text">Masukkan kata kunci tambahan untuk topik yang lebih fokus.</div>
                </div>
                <div class="col-md-6">
                    <label for="toneStyle" class="form-label fw-bold">Gaya Bahasa & Tone:</label>
                    <select id="toneStyle" class="form-select">
                        <option value="informatif">Informatif & Formal</option>
                        <option value="santai">Santai & Kekinian</option>
                        <option value="motivasi">Motivasi & Inspiratif</option>
                        <option value="humor">Humor & Lucu</option>
                        <option value="profesional">Profesional & Bisnis</option>
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6 mb-3 mb-md-0">
                    <label for="numTips" class="form-label fw-bold">Jumlah Poin/Tips per Thread:</label>
                    <input type="number" id="numTips" class="form-control" value="7" min="3" max="15">
                    <div class="form-text">Antara 3 sampai 15 poin per thread.</div>
                </div>
                <div class="col-md-6">
                    <label for="targetAudience" class="form-label fw-bold">Target Audiens:</label>
                    <select id="targetAudience" class="form-select">
                        <option value="umum">Masyarakat Umum</option>
                        <option value="pemula">Pemula/Awam</option>
                        <option value="mahasiswa">Mahasiswa/Pelajar</option>
                        <option value="pebisnis">Pebisnis UKM/Freelancer</option>
                        <option value="profesional">Profesional/Ahli</option>
                        <option value="developer">Developer/Programmer</option>
                    </select>
                </div>
            </div>

            <div class="mb-4">
                <label for="outputFormat" class="form-label fw-bold">Pilih Format Output:</label>
                <div class="output-format-selector" id="outputFormat">
                    <div class="output-format-badge active" data-format="thread">Thread Media Sosial</div>
                    <div class="output-format-badge" data-format="blog-outline">Outline Blog Post</div>
                    <div class="output-format-badge" data-format="caption">Caption Singkat</div>
                </div>
            </div>

            <button id="showCtaManagerBtn" class="btn btn-outline-info mb-3 w-100" type="button" data-bs-toggle="collapse" data-bs-target="#ctaManagerCollapse" aria-expanded="false" aria-controls="ctaManagerCollapse">
                <i class="bi bi-gear-fill me-2"></i> Manajemen Call-to-Action (CTA) Kustom
            </button>
            <div class="collapse mb-4 cta-manager-section" id="ctaManagerCollapse">
                <h5 class="mb-3">Daftar CTA Kustom Anda</h5>
                <div class="input-group mb-3">
                    <textarea id="newCtaText" class="form-control" placeholder="Masukkan teks CTA baru (contoh: Kunjungi website kami di...)"></textarea>
                    <button class="btn btn-success" id="addCtaBtn"><i class="bi bi-plus-lg"></i> Tambah CTA</button>
                </div>
                <div id="ctaList" class="cta-list-group">
                    <!-- Custom CTAs will be loaded here -->
                </div>
                <div class="mt-3">
                    <label class="form-label fw-bold">Pilih CTA untuk Digunakan:</label>
                    <select id="selectedCta" class="form-select">
                        <option value="default">Gunakan CTA Default (yang sudah ada)</option>
                        <!-- Custom CTAs will be added here -->
                    </select>
                </div>
            </div>

            <button id="generateBtn" class="btn btn-primary btn-lg w-100">
                <i class="bi bi-magic me-2"></i>Generate Konten Sekarang
            </button>
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2" id="loadingMessage">Sedang menghasilkan konten...</p>
            </div>
        </div>

        <div class="image-prompt-section" id="imagePromptSection" style="display: none;">
            <h4 class="mb-3">Prompt untuk AI Gambar</h4>
            <div class="alert alert-info" role="alert">
                Gunakan prompt di bawah ini di tool AI Gambar favorit Anda (contoh: Midjourney, DALL-E, Stable Diffusion) untuk menghasilkan visual yang relevan dengan konten Anda.
            </div>
            <div class="input-group">
                <textarea id="imageGenPrompt" class="form-control" rows="3" readonly></textarea>
                <button class="btn btn-outline-secondary" id="copyImagePromptBtn"><i class="bi bi-clipboard"></i> Salin Prompt Gambar</button>
            </div>
        </div>

        <div class="preview-section" id="previewSection" style="display: none;">
            <h4 class="mb-3">Pratinjau Posting</h4>
            <div class="alert alert-info" role="alert">
                Ini adalah perkiraan bagaimana konten Anda akan terlihat di platform media sosial.
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="preview-box">
                        <div class="preview-header"><i class="bi bi-twitter-x me-1"></i> Twitter / X Preview</div>
                        <div id="twitterPreview" class="preview-text"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="preview-box">
                        <div class="preview-header"><i class="bi bi-instagram me-1"></i> Instagram Preview</div>
                        <div id="instagramPreview" class="preview-text"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <h3 class="mb-4 d-flex justify-content-between align-items-center">
                    Konten AI Hari Ini
                    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#historyModal"><i class="bi bi-clock-history me-2"></i> Lihat Riwayat</button>
                </h3>
                <div id="threadsContainer" class="thread-container">
                    <!-- Thread akan dimuat di sini -->
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="historyModalLabel">Riwayat Generasi Konten</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="historyContent">
                    <!-- History threads will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-danger" id="clearHistoryBtn"><i class="bi bi-trash me-2"></i> Bersihkan Riwayat</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container">
        <div id="copyToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Berhasil Disalin</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Teks telah disalin ke clipboard
            </div>
        </div>
        <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-danger text-white">
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="errorMessage">
                Terjadi kesalahan saat menghasilkan konten
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Global Variables ---
            let selectedTopic = 'umum';
            let selectedOutputFormat = 'thread';
            let customCTAs = [];
            let generatedContentHistory = [];

            // --- UI Elements Cache ---
            const apiKeyInput = document.getElementById('apiKey');
            const saveApiKeyBtn = document.getElementById('saveApiKey');
            const apiStatusIndicator = document.getElementById('apiStatus');
            const apiStatusText = document.getElementById('apiStatusText');
            const lastGeneratedSpan = document.getElementById('lastGenerated');
            const generateBtn = document.getElementById('generateBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const loadingMessage = document.getElementById('loadingMessage');
            const threadsContainer = document.getElementById('threadsContainer');
            const topicBadges = document.querySelectorAll('.topic-badge');
            const outputFormatBadges = document.querySelectorAll('.output-format-badge');
            const specificKeywordsInput = document.getElementById('specificKeywords');
            const toneStyleSelect = document.getElementById('toneStyle');
            const numTipsInput = document.getElementById('numTips');
            const targetAudienceSelect = document.getElementById('targetAudience');
            const newCtaTextarea = document.getElementById('newCtaText');
            const addCtaBtn = document.getElementById('addCtaBtn');
            const ctaListDiv = document.getElementById('ctaList');
            const selectedCtaSelect = document.getElementById('selectedCta');
            const imagePromptSection = document.getElementById('imagePromptSection');
            const imageGenPromptTextarea = document.getElementById('imageGenPrompt');
            const copyImagePromptBtn = document.getElementById('copyImagePromptBtn');
            const previewSection = document.getElementById('previewSection');
            const twitterPreviewDiv = document.getElementById('twitterPreview');
            const instagramPreviewDiv = document.getElementById('instagramPreview');
            const historyContentDiv = document.getElementById('historyContent');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');


            // --- Initialization ---
            loadApiKey();
            loadCustomCTAs();
            loadGeneratedHistory();
            renderCustomCTAs(); // Initial render for CTA list and dropdown
            updateApiStatus(localStorage.getItem('geminiApiKey') !== null);

            // --- Event Listeners ---
            saveApiKeyBtn.addEventListener('click', saveApiKey);
            generateBtn.addEventListener('click', handleGenerateClick);
            copyImagePromptBtn.addEventListener('click', () => copyToClipboard(imageGenPromptTextarea.value));
            clearHistoryBtn.addEventListener('click', clearHistory);

            topicBadges.forEach(badge => {
                badge.addEventListener('click', function() {
                    topicBadges.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedTopic = this.getAttribute('data-topic');
                });
            });

            outputFormatBadges.forEach(badge => {
                badge.addEventListener('click', function() {
                    outputFormatBadges.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedOutputFormat = this.getAttribute('data-format');
                });
            });

            addCtaBtn.addEventListener('click', addCustomCta);
            ctaListDiv.addEventListener('click', handleCtaListActions); // Delegate events for edit/delete buttons

            // --- API Key Management ---
            function loadApiKey() {
                const savedApiKey = localStorage.getItem('geminiApiKey');
                if (savedApiKey) {
                    apiKeyInput.value = savedApiKey;
                }
            }

            function saveApiKey() {
                const apiKey = apiKeyInput.value.trim();
                if (apiKey !== '') {
                    localStorage.setItem('geminiApiKey', apiKey);
                    updateApiStatus(true);
                    showToast('API Key berhasil disimpan');
                } else {
                    localStorage.removeItem('geminiApiKey');
                    updateApiStatus(false);
                    showError('API Key tidak boleh kosong');
                }
            }

            function updateApiStatus(isConnected) {
                if (isConnected) {
                    apiStatusIndicator.classList.add('status-active');
                    apiStatusIndicator.classList.remove('status-inactive');
                    apiStatusText.textContent = 'Status API: Terhubung';
                } else {
                    apiStatusIndicator.classList.add('status-inactive');
                    apiStatusIndicator.classList.remove('status-active');
                    apiStatusText.textContent = 'Status API: Tidak terhubung';
                }
            }

            // --- Toast Notifications ---
            function showToast(message, type = 'success') {
                const toastElement = document.getElementById('copyToast');
                const toastHeader = toastElement.querySelector('.toast-header');
                const toastBody = toastElement.querySelector('.toast-body');

                toastBody.textContent = message;
                toastHeader.className = 'toast-header'; // Reset classes
                if (type === 'success') {
                    toastHeader.classList.add('bg-success', 'text-white');
                } else if (type === 'warning') {
                    toastHeader.classList.add('bg-warning', 'text-dark');
                } else if (type === 'danger') {
                    toastHeader.classList.add('bg-danger', 'text-white');
                } else {
                    toastHeader.classList.add('bg-primary', 'text-white');
                }

                const toast = new bootstrap.Toast(toastElement);
                toast.show();
            }

            function showError(message) {
                const toastElement = document.getElementById('errorToast');
                document.getElementById('errorMessage').textContent = message;
                const toast = new bootstrap.Toast(toastElement);
                toast.show();
            }

            // --- Copy to Clipboard ---
            function copyToClipboard(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showToast('Teks berhasil disalin');
                    } else {
                        showToast('Gagal menyalin teks', 'danger');
                    }
                } catch (err) {
                    showToast('Gagal menyalin teks', 'danger');
                    console.error('Gagal menyalin: ', err);
                } finally {
                    document.body.removeChild(textarea);
                }
            }

            // --- Custom CTA Management ---
            function loadCustomCTAs() {
                const savedCTAs = localStorage.getItem('customCTAs');
                if (savedCTAs) {
                    customCTAs = JSON.parse(savedCTAs);
                }
            }

            function saveCustomCTAs() {
                localStorage.setItem('customCTAs', JSON.stringify(customCTAs));
                renderCustomCTAs();
            }

            function renderCustomCTAs() {
                ctaListDiv.innerHTML = '';
                selectedCtaSelect.innerHTML = '<option value="default">Gunakan CTA Default (yang sudah ada)</option>';

                if (customCTAs.length === 0) {
                    ctaListDiv.innerHTML = '<div class="p-3 text-muted">Belum ada CTA kustom yang disimpan.</div>';
                }

                customCTAs.forEach((cta, index) => {
                    // Render in CTA list manager
                    const ctaItem = document.createElement('div');
                    ctaItem.className = 'cta-list-item';
                    ctaItem.innerHTML = `
                        <span class="cta-text flex-grow-1 me-2">${cta}</span>
                        <div class="cta-actions">
                            <button class="btn btn-sm btn-outline-info edit-cta-btn" data-index="${index}"><i class="bi bi-pencil-fill"></i></button>
                            <button class="btn btn-sm btn-outline-danger delete-cta-btn" data-index="${index}"><i class="bi bi-trash-fill"></i></button>
                        </div>
                    `;
                    ctaListDiv.appendChild(ctaItem);

                    // Add to select dropdown
                    const option = document.createElement('option');
                    option.value = cta;
                    option.textContent = cta;
                    selectedCtaSelect.appendChild(option);
                });
            }

            function addCustomCta() {
                const ctaText = newCtaTextarea.value.trim();
                if (ctaText) {
                    customCTAs.push(ctaText);
                    saveCustomCTAs();
                    newCtaTextarea.value = '';
                    showToast('CTA kustom berhasil ditambahkan');
                } else {
                    showError('Teks CTA tidak boleh kosong');
                }
            }

            function handleCtaListActions(event) {
                const target = event.target;
                const index = target.closest('button')?.dataset.index;

                if (index === undefined) return;

                if (target.classList.contains('delete-cta-btn') || target.parentElement.classList.contains('delete-cta-btn')) {
                    if (confirm('Anda yakin ingin menghapus CTA ini?')) {
                        customCTAs.splice(index, 1);
                        saveCustomCTAs();
                        showToast('CTA kustom berhasil dihapus');
                    }
                } else if (target.classList.contains('edit-cta-btn') || target.parentElement.classList.contains('edit-cta-btn')) {
                    const currentText = customCTAs[index];
                    const newText = prompt('Edit teks CTA:', currentText);
                    if (newText !== null && newText.trim() !== '') {
                        customCTAs[index] = newText.trim();
                        saveCustomCTAs();
                        showToast('CTA kustom berhasil diperbarui');
                    } else if (newText !== null) {
                        showError('Teks CTA tidak boleh kosong');
                    }
                }
            }

            // --- History Management ---
            function loadGeneratedHistory() {
                const savedHistory = localStorage.getItem('generatedContentHistory');
                if (savedHistory) {
                    generatedContentHistory = JSON.parse(savedHistory);
                }
            }

            function saveGeneratedHistory() {
                localStorage.setItem('generatedContentHistory', JSON.stringify(generatedContentHistory));
            }

            function renderHistoryModal() {
                historyContentDiv.innerHTML = '';
                if (generatedContentHistory.length === 0) {
                    historyContentDiv.innerHTML = '<p class="text-center text-muted">Belum ada riwayat generasi konten.</p>';
                    return;
                }
                
                generatedContentHistory.slice().reverse().forEach((record, idx) => { // Reverse to show latest first
                    const historyCard = document.createElement('div');
                    historyCard.className = 'thread-card'; // Reuse thread-card style
                    historyCard.style.marginBottom = '1rem';
                    
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'thread-header small text-muted mb-2';
                    dateHeader.textContent = `Generated: ${new Date(record.date).toLocaleString('id-ID')} | Topik: ${record.topic} | Format: ${record.format}`;
                    
                    historyCard.appendChild(dateHeader);

                    if (record.format === 'thread') {
                        record.content.threads.forEach((thread, index) => {
                            const threadElement = createThread(thread, index, true, record.cta); // true for history, disable editing
                            threadElement.querySelector('.thread-header').textContent = `Thread ${index + 1}`; // Adjust header for history view
                            historyCard.appendChild(threadElement);
                        });
                    } else if (record.format === 'blog-outline') {
                        const contentDiv = document.createElement('div');
                        contentDiv.innerHTML = `<h6 class="mb-2">Outline Blog Post:</h6><div class="prompt-item">${record.content.outline.replace(/\n/g, '<br>')}</div>`;
                        historyCard.appendChild(contentDiv);
                    } else if (record.format === 'caption') {
                        const contentDiv = document.createElement('div');
                        contentDiv.innerHTML = `<h6 class="mb-2">Caption Singkat:</h6><div class="prompt-item">${record.content.caption.replace(/\n/g, '<br>')}</div>`;
                        historyCard.appendChild(contentDiv);
                    }

                    // Add image prompt if available
                    if (record.imagePrompt) {
                        const imgPromptDiv = document.createElement('div');
                        imgPromptDiv.className = 'cta-section mt-3'; // Reuse cta-section style
                        imgPromptDiv.innerHTML = `
                            <p class="mb-1"><strong>Prompt Gambar AI:</strong></p>
                            <div class="input-group">
                                <textarea class="form-control" rows="2" readonly>${record.imagePrompt}</textarea>
                                <button class="btn btn-sm btn-outline-secondary copy-history-img-prompt" data-prompt="${record.imagePrompt}"><i class="bi bi-clipboard"></i></button>
                            </div>
                        `;
                        historyCard.appendChild(imgPromptDiv);
                    }
                    
                    historyContentDiv.appendChild(historyCard);
                });

                // Add event listeners for copy buttons in history modal
                historyContentDiv.querySelectorAll('.copy-history-img-prompt').forEach(btn => {
                    btn.addEventListener('click', function() {
                        copyToClipboard(this.dataset.prompt);
                    });
                });
            }

            function clearHistory() {
                if (confirm('Anda yakin ingin menghapus semua riwayat generasi konten?')) {
                    generatedContentHistory = [];
                    saveGeneratedHistory();
                    renderHistoryModal();
                    showToast('Riwayat berhasil dibersihkan');
                }
            }

            // Listen for modal show event to render history
            const historyModal = document.getElementById('historyModal');
            historyModal.addEventListener('show.bs.modal', renderHistoryModal);

            // --- Content Generation (Main Logic) ---
            async function handleGenerateClick() {
                const apiKey = localStorage.getItem('geminiApiKey');
                if (!apiKey) {
                    showError('Silakan masukkan API Key terlebih dahulu');
                    return;
                }
                
                // Collect all parameters
                const params = {
                    topic: selectedTopic,
                    keywords: specificKeywordsInput.value.trim(),
                    tone: toneStyleSelect.value,
                    numTips: parseInt(numTipsInput.value) || 7,
                    audience: targetAudienceSelect.value,
                    outputFormat: selectedOutputFormat,
                    customCta: selectedCtaSelect.value === 'default' ? null : selectedCtaSelect.value,
                };
                
                await generateContentWithAPI(apiKey, params);
            }

            function updateLoadingMessage(message) {
                loadingMessage.innerHTML = `<div class="loading-text-spinner me-2"></div> ${message}`;
            }

            async function generateContentWithAPI(apiKey, params) {
                // Clear previous results
                threadsContainer.innerHTML = '';
                imagePromptSection.style.display = 'none';
                previewSection.style.display = 'none';

                // Show loading state
                loadingSpinner.classList.add('active');
                generateBtn.disabled = true;
                updateLoadingMessage('Sedang menyiapkan permintaan...');
                
                let defaultCtaText = selectedCtaSelect.value === 'default' ? `PS: Saya juga buka kelas AI untuk kamu yang benar-benar awam!\nKeunggulannya: setiap hari ada postingan tutorial terbaru, update terus.\nBelajar bisa kapan saja mulai jam 08.00 sampai 00.00 WIB.\nBebas belajar sampai bisa, sistem bayar per 10 hari.\nDan yang paling penting, harganya terjangkau dan disesuaikan.\nLangsung klik: https://lynk.id/vdmax` : params.customCta;

                let prompt = '';
                // Dynamic prompt construction based on format and other parameters
                switch(params.outputFormat) {
                    case 'thread':
                        prompt = buildThreadPrompt(params);
                        break;
                    case 'blog-outline':
                        prompt = buildBlogOutlinePrompt(params);
                        break;
                    case 'caption':
                        prompt = buildCaptionPrompt(params);
                        break;
                    default:
                        prompt = buildThreadPrompt(params); // Fallback to thread
                }

                try {
                    updateLoadingMessage('Mengirim permintaan ke Gemini...');
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }]
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
                    }

                    updateLoadingMessage('Menganalisis respons dari AI...');
                    const data = await response.json();
                    const responseText = data.candidates[0].content.parts[0].text;
                    
                    // Extract JSON from response
                    let jsonMatch = responseText.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('Format respons tidak valid atau tidak ditemukan JSON.');
                    }
                    
                    const generatedData = JSON.parse(jsonMatch[0]);
                    
                    let imagePrompt = '';
                    let previewMainContent = '';
                    let previewPrompts = [];

                    // Render based on output format
                    if (params.outputFormat === 'thread') {
                        threadsContainer.innerHTML = '';
                        if (generatedData.threads && generatedData.threads.length > 0) {
                            generatedData.threads.forEach((thread, index) => {
                                const threadElement = createThread(thread, index, false, defaultCtaText);
                                threadsContainer.appendChild(threadElement);
                            });
                            previewMainContent = generatedData.threads[0].hook;
                            previewPrompts = generatedData.threads[0].prompts;
                            imagePrompt = buildImagePromptFromThread(generatedData.threads[0].hook, params.topic, params.keywords);
                        } else {
                             throw new Error('Tidak ada thread yang dihasilkan.');
                        }
                    } else if (params.outputFormat === 'blog-outline') {
                        threadsContainer.innerHTML = `
                            <div class="thread-card">
                                <h4 class="mb-3">Outline Blog Post</h4>
                                <div class="prompt-item editable-content" contenteditable="true">${generatedData.outline.replace(/\n/g, '<br>')}</div>
                                <button class="btn btn-sm btn-outline-primary mt-3" onclick="copyToClipboard(document.querySelector('.thread-card .prompt-item.editable-content').innerText)"><i class="bi bi-clipboard me-1"></i> Salin Outline</button>
                            </div>
                        `;
                        previewMainContent = generatedData.outline;
                        imagePrompt = buildImagePromptFromBlogOutline(generatedData.outline, params.topic, params.keywords);

                    } else if (params.outputFormat === 'caption') {
                        threadsContainer.innerHTML = `
                            <div class="thread-card">
                                <h4 class="mb-3">Caption Singkat</h4>
                                <div class="prompt-item editable-content" contenteditable="true">${generatedData.caption.replace(/\n/g, '<br>')}</div>
                                <button class="btn btn-sm btn-outline-primary mt-3" onclick="copyToClipboard(document.querySelector('.thread-card .prompt-item.editable-content').innerText)"><i class="bi bi-clipboard me-1"></i> Salin Caption</button>
                            </div>
                        `;
                        previewMainContent = generatedData.caption;
                        imagePrompt = buildImagePromptFromCaption(generatedData.caption, params.topic, params.keywords);
                    }

                    // Display image prompt section
                    imageGenPromptTextarea.value = imagePrompt;
                    imagePromptSection.style.display = 'block';

                    // Render posting preview
                    renderPostingPreview(previewMainContent, previewPrompts, defaultCtaText, params.outputFormat);

                    // Update last generated time
                    const now = new Date();
                    lastGeneratedSpan.textContent = now.toLocaleString('id-ID');
                    
                    showToast('Konten berhasil dihasilkan!');

                    // Add to history
                    generatedContentHistory.push({
                        date: now.toISOString(),
                        topic: params.topic,
                        format: params.outputFormat,
                        content: generatedData,
                        imagePrompt: imagePrompt,
                        cta: defaultCtaText
                    });
                    saveGeneratedHistory();
                    
                } catch (error) {
                    console.error('Error:', error);
                    showError(`Gagal menghasilkan konten: ${error.message}. Coba lagi atau sesuaikan prompt.`);
                    
                    // Fallback to sample threads if error, based on selected format/topic
                    generateSampleThreads(params.topic, defaultCtaText); // Use default CTA here too
                } finally {
                    // Sembunyikan loading state
                    loadingSpinner.classList.remove('active');
                    generateBtn.disabled = false;
                }
            }

            // --- Prompt Builders ---
            function buildThreadPrompt(params) {
                const { topic, keywords, tone, numTips, audience } = params;
                const keywordPhrase = keywords ? ` tentang "${keywords}"` : '';
                const audiencePhrase = audience !== 'umum' ? ` untuk ${audience}` : '';

                return `Buat 3 thread unik berupa teks saja (tanpa em-dash maupun emoji), dengan gaya bahasa ${tone} dan target audiens ${audiencePhrase}. Topik utamanya adalah ${topic}${keywordPhrase}.
                
                Setiap thread harus:
                1. Diawali dengan kalimat hook yang menarik.
                2. Berisi ${numTips} tips, tutorial, atau cara praktis.
                3. Setiap tips diawali dengan bullet point (•) dan tidak terlalu panjang.
                
                Format respons JSON:
                {
                    "threads": [
                        {
                            "hook": "Kalimat hook yang menarik",
                            "prompts": ["Tips 1", "Tips 2", ...]
                        },
                        {...},
                        {...}
                    ]
                }
                
                Pastikan respons dalam format JSON yang valid dan mudah diparse.`;
            }

            function buildBlogOutlinePrompt(params) {
                const { topic, keywords, tone, audience } = params;
                const keywordPhrase = keywords ? ` dengan fokus "${keywords}"` : '';
                const audiencePhrase = audience !== 'umum' ? ` untuk audiens ${audience}` : '';

                return `Buat outline (kerangka) blog post yang detail dan komprehensif, dengan gaya bahasa ${tone}${audiencePhrase}. Topiknya adalah "${topic}"${keywordPhrase}.
                
                Outline harus mencakup:
                - Judul yang menarik
                - Pendahuluan (dengan hook)
                - Beberapa poin utama (dengan sub-poin jika perlu)
                - Kesimpulan (dengan Call-to-Action)
                
                Format respons JSON:
                {
                    "outline": "Judul Blog Post\\n\\nI. Pendahuluan\\n   A. Hook awal\\n   B. Pentingnya topik\\nII. Poin Utama 1\\n   A. Sub-poin 1.1\\n   B. Sub-poin 1.2\\nIII. Poin Utama 2\\n   ...\\nIV. Kesimpulan\\n   A. Ringkasan poin utama\\n   B. Call-to-Action"
                }
                
                Gunakan format teks polos dengan baris baru (\\n) untuk setiap poin. Pastikan respons dalam format JSON yang valid.`;
            }

            function buildCaptionPrompt(params) {
                const { topic, keywords, tone, audience } = params;
                const keywordPhrase = keywords ? ` terkait "${keywords}"` : '';
                const audiencePhrase = audience !== 'umum' ? ` untuk audiens ${audience}` : '';

                return `Buat 3 caption media sosial yang singkat dan menarik, dengan gaya bahasa ${tone} dan target audiens ${audiencePhrase}. Topiknya adalah "${topic}"${keywordPhrase}.
                
                Setiap caption harus:
                1. Maksimal 150 kata.
                2. Mengandung satu atau dua kalimat pembuka yang menarik.
                3. Beberapa poin singkat atau ajakan bertindak.
                4. Menggunakan maksimal 5 hashtag yang relevan.
                5. Tanpa emoji atau em-dash.
                
                Format respons JSON:
                {
                    "captions": ["Caption 1", "Caption 2", "Caption 3"]
                }
                
                Pastikan respons dalam format JSON yang valid.`;
            }

            // --- Thread / Content Rendering ---
            function createThread(threadData, index, isHistory = false, ctaText = null) {
                const threadCard = document.createElement('div');
                threadCard.className = 'thread-card';
                
                const header = document.createElement('div');
                header.className = 'thread-header';
                header.textContent = `Thread ${index + 1}`;
                
                const hook = document.createElement('div');
                hook.className = 'prompt-item';
                
                const hookText = document.createElement('span');
                hookText.className = 'editable-content';
                hookText.textContent = threadData.hook;
                if (!isHistory) { // Enable editing only for current generation
                    hookText.setAttribute('contenteditable', 'true');
                }
                
                const hookCopyBtn = document.createElement('button');
                hookCopyBtn.className = 'copy-btn';
                hookCopyBtn.innerHTML = '<i class="bi bi-clipboard"></i>';
                hookCopyBtn.addEventListener('click', function() {
                    copyToClipboard(hookText.innerText);
                });
                
                hook.appendChild(hookText);
                hook.appendChild(hookCopyBtn);
                
                const promptsContainer = document.createElement('div');
                
                threadData.prompts.forEach(prompt => {
                    const promptItem = document.createElement('div');
                    promptItem.className = 'prompt-item';
                    
                    const promptText = document.createElement('span');
                    promptText.className = 'editable-content';
                    promptText.textContent = `• ${prompt}`;
                    if (!isHistory) { // Enable editing only for current generation
                        promptText.setAttribute('contenteditable', 'true');
                    }
                    
                    const promptCopyBtn = document.createElement('button');
                    promptCopyBtn.className = 'copy-btn';
                    promptCopyBtn.innerHTML = '<i class="bi bi-clipboard"></i>';
                    promptCopyBtn.addEventListener('click', function() {
                        copyToClipboard(promptText.innerText);
                    });
                    
                    promptItem.appendChild(promptText);
                    promptItem.appendChild(promptCopyBtn);
                    promptsContainer.appendChild(promptItem);
                });
                
                const ctaSection = document.createElement('div');
                ctaSection.className = 'cta-section';
                
                const ctaDisplay = ctaText.replace(/\n/g, '<br>'); // Use the plain text CTA, convert newlines for HTML display

                const ctaTextElement = document.createElement('div');
                ctaTextElement.innerHTML = ctaDisplay;
                
                const ctaCopyBtn = document.createElement('button');
                ctaCopyBtn.className = 'btn btn-sm btn-outline-primary';
                ctaCopyBtn.innerHTML = '<i class="bi bi-clipboard me-1"></i> Salin CTA';
                ctaCopyBtn.addEventListener('click', function() {
                    copyToClipboard(ctaText); // Copy the original plain text CTA
                });
                
                const ctaContainer = document.createElement('div');
                ctaContainer.className = 'd-flex justify-content-between align-items-center';
                ctaContainer.appendChild(ctaTextElement);
                if (!isHistory) { // Hide CTA copy button in history view as it's part of full copy
                    ctaContainer.appendChild(ctaCopyBtn);
                }
                
                ctaSection.appendChild(ctaContainer);
                
                threadCard.appendChild(header);
                threadCard.appendChild(hook);
                threadCard.appendChild(promptsContainer);
                threadCard.appendChild(ctaSection);

                if (!isHistory) { // Add a full copy button only for current generation
                    const fullCopyBtn = document.createElement('button');
                    fullCopyBtn.className = 'btn btn-sm btn-info mt-3 w-100';
                    fullCopyBtn.innerHTML = '<i class="bi bi-clipboard-check me-1"></i> Salin Seluruh Thread';
                    fullCopyBtn.addEventListener('click', function() {
                        let fullThreadText = hookText.innerText + '\n\n';
                        promptsContainer.querySelectorAll('.editable-content').forEach(p => {
                            fullThreadText += p.innerText + '\n';
                        });
                        fullThreadText += '\n' + ctaText; // Append the plain text CTA
                        copyToClipboard(fullThreadText);
                    });
                    threadCard.appendChild(fullCopyBtn);
                }
                
                return threadCard;
            }

            // --- Image Prompt Generation ---
            function buildImagePromptFromThread(hook, topic, keywords) {
                let basePrompt = `Generate a visually appealing, high-quality image for a social media post.`;
                let subject = hook.split('.')[0] || '';
                if (subject.length > 50) subject = subject.substring(0, 50) + '...'; // Truncate long hooks

                let style = '';
                switch(toneStyleSelect.value) {
                    case 'santai': style = ' in a vibrant, friendly, and approachable cartoon style'; break;
                    case 'motivasi': style = ' in an inspiring, cinematic, and bright style'; break;
                    case 'humor': style = ' in a humorous, quirky, and playful illustration style'; break;
                    case 'profesional': style = ' in a sleek, modern, and professional corporate style'; break;
                    default: style = ' in a clear, modern, and informative graphic design style'; break;
                }

                let focus = `The image should represent "${subject}" related to teknologi.`; // Changed from dynamic topic to fixed 'teknologi' as per original image text
                let details = `Include elements that convey learning, technology, and practical application. Avoid text within the image. Focus on a clear, single focal point.`;

                return `${basePrompt} ${focus} ${details}${style}.`;
            }

            function buildImagePromptFromBlogOutline(outline, topic, keywords) {
                const titleMatch = outline.match(/^Judul Blog Post:\s*([^\n]+)/); // Adjusted regex to match the exact string
                const title = titleMatch ? titleMatch[1].trim() : (outline.split('\n')[0] || '').replace('Judul Blog Post:', '').trim();
                return `Generate a captivating blog post header image for an article titled "${title}". The image should be professional, relevant to ${topic}${keywords ? ` and ${keywords}` : ''}, and visually engaging. Consider abstract representations of data, technology, or learning. Aspect ratio 16:9.`;
            }

            function buildImagePromptFromCaption(caption, topic, keywords) {
                const firstSentence = caption.split('.')[0] || '';
                return `Create a striking image for a short social media caption. The image should be highly engaging, directly relevant to ${topic}${keywords ? ` and ${keywords}` : ''}, and capture attention immediately. Focus on the core message: "${firstSentence}". Style: modern, clean, and vibrant.`;
            }

            // --- Posting Preview ---
            function renderPostingPreview(mainContent, prompts = [], cta, format) {
                previewSection.style.display = 'block';
                
                let twitterText = '';
                let instagramText = '';
                let cleanedCta = cta; // cta parameter here should already be the plain text version

                if (format === 'thread') {
                    // Twitter/X Preview
                    twitterText = `${mainContent}\n\n`; // Removed emoji from start
                    prompts.forEach(p => twitterText += `${p}\n`);
                    twitterText += `\n${cleanedCta}\n\n#AI #TipsAI #Tutorial`; // <--- Perbaikan di sini

                    // Instagram Preview
                    instagramText = `*${mainContent}*\n\n`; // Kept asterisks for bolding, removed emoji from start
                    prompts.forEach(p => instagramText += `${p.replace('• ', '')}\n`); // Removed bullet emoji (➡️)
                    instagramText += `\n${cleanedCta}\n\n#AI #Tips #Productivity`;
                } else if (format === 'blog-outline') {
                    const blogTitle = mainContent.split('\n')[0].replace('Judul Blog Post:', '').trim();
                    const blogIntro = mainContent.split('\n')[2] ? mainContent.split('\n')[2].replace('I. Pendahuluan', '').trim() : '';

                    twitterText = `Artikel Baru: ${blogTitle}\n\nBaca outline lengkapnya untuk memahami struktur mendalam.\n\n${cleanedCta}\n\n#BlogAI #KontenAI`;
                    instagramText = `*${blogTitle}*\n\n${blogIntro}\n\nLihat struktur lengkapnya untuk panduan menulis Anda!\n\n${cleanedCta}\n\n#Blog #Outline #AIWriting`;
                } else if (format === 'caption') {
                    twitterText = mainContent;
                    instagramText = mainContent.replace(/#(\w+)/g, '#$1'); // Ensure no extra emojis like 👇 are added around hashtags
                }

                // Trim to typical character limits for preview
                twitterPreviewDiv.textContent = twitterText.substring(0, 500) + (twitterText.length > 500 ? '...' : '');
                instagramPreviewDiv.textContent = instagramText.substring(0, 1000) + (instagramText.length > 1000 ? '...' : '');
            }

            // --- Sample Threads (Fallback) ---
            function generateSampleThreads(topic, ctaText) {
                let threads = [];
                let ctaUsed = ctaText || `PS: Saya juga buka kelas AI untuk kamu yang benar-benar awam!\nKeunggulannya: setiap hari ada postingan tutorial terbaru, update terus.\nBelajar bisa kapan saja mulai jam 08.00 sampai 00.00 WIB.\nBebas belajar sampai bisa, sistem bayar per 10 hari.\nDan yang paling penting, harganya terjangkau dan disesuaikan.\nLangsung klik: https://lynk.id/vdmax`;
                
                let sampleMainContent = '';
                let samplePrompts = [];
                let sampleImagePrompt = '';

                // Simplified sample data for various formats
                if (selectedOutputFormat === 'thread') {
                    switch(topic) {
                        case 'chatgpt':
                            threads = [
                                {
                                    hook: "Punya bisnis kecil atau kerja freelance? Gunakan ChatGPT buat bantu kerja lebih cepat dan hemat waktu.",
                                    prompts: [
                                        "• Buat template penawaran harga untuk jasa desain grafis",
                                        "• Tulis ulang deskripsi produk ini agar lebih menjual dan jelas",
                                        "• Buat daftar pertanyaan wawancara awal untuk klien baru",
                                        "• Susun email follow-up profesional untuk prospek yang belum merespons",
                                        "• Rancang 3 opsi bio Instagram bisnis yang singkat dan efektif",
                                        "• Buat ringkasan pitch produk 60 detik untuk presentasi lisan",
                                        "• Ubah testimoni pelanggan ini jadi konten testimonial bergaya narasi"
                                    ]
                                },
                                {
                                    hook: "Ingin meningkatkan produktivitas kerja? ChatGPT bisa jadi asisten pribadi Anda untuk berbagai tugas.",
                                    prompts: [
                                        "• Buat ringkasan meeting dari catatan ini dalam poin-poin penting",
                                        "• Susun agenda meeting untuk tim produktif dengan durasi 30 menit",
                                        "• Tulis draft email untuk meminta perpanjangan deadline proyek",
                                        "• Buat prioritas tugas harian berdasarkan daftar pekerjaan ini",
                                        "• Rancang template laporan progress mingguan yang singkat dan jelas",
                                        "• Tulis 3 opsi balasan untuk email keluhan pelanggan",
                                        "• Buat daftar pertanyaan untuk evaluasi performa karyawan"
                                    ]
                                }
                            ];
                            break;
                        default: // umum
                            threads = [
                                {
                                    hook: "Ponsel pintar Anda mulai terasa lambat dan kurang responsif?",
                                    prompts: [
                                        "• Hapus aplikasi yang tidak terpakai secara rutin untuk membebaskan ruang penyimpanan.",
                                        "• Bersihkan cache aplikasi secara berkala melalui pengaturan ponsel Anda.",
                                        "• Nonaktifkan fitur sinkronisasi otomatis untuk aplikasi yang tidak esensial.",
                                        "• Hindari penggunaan banyak widget di layar utama yang dapat memakan sumber daya.",
                                        "• Perbarui sistem operasi dan aplikasi Anda ke versi terbaru untuk perbaikan kinerja."
                                    ]
                                },
                                {
                                    hook: "Sering merasa baterai HP cepat habis dan performa menurun?",
                                    prompts: [
                                        "• Kurangi kecerahan layar dan aktifkan mode hemat daya.",
                                        "• Tutup aplikasi yang berjalan di latar belakang saat tidak digunakan.",
                                        "• Nonaktifkan lokasi, Bluetooth, dan Wi-Fi jika tidak diperlukan.",
                                        "• Hindari paparan suhu ekstrem yang dapat merusak baterai.",
                                        "• Gunakan pengisi daya original atau berkualitas tinggi.",
                                        "• Lakukan restart ponsel secara berkala untuk menyegarkan sistem."
                                    ]
                                }
                            ];
                    }
                    threadsContainer.innerHTML = '';
                    threads.forEach((thread, index) => {
                        const threadElement = createThread(thread, index, false, ctaUsed);
                        threadsContainer.appendChild(threadElement);
                    });
                    sampleMainContent = threads[0].hook;
                    samplePrompts = threads[0].prompts;
                    sampleImagePrompt = buildImagePromptFromThread(threads[0].hook, topic, specificKeywordsInput.value.trim());

                } else if (selectedOutputFormat === 'blog-outline') {
                    const sampleOutlineText = `Judul Blog Post: ${topic} dan Masa Depan Kita\n\nI. Pendahuluan\n   A. Apa itu ${topic} dan mengapa penting?\n   B. Gambaran singkat evolusi ${topic}\nII. Aplikasi ${topic} dalam Kehidupan Sehari-hari\n   A. Contoh di smartphone Anda\n   B. Di industri dan bisnis\nIII. Tantangan dan Etika ${topic}\n   A. Isu privasi data\n   B. Potensi bias AI\nIV. Masa Depan ${topic} dan Rekomendasi\n   A. Prediksi perkembangan ke depan\n   B. Cara beradaptasi dengan ${topic}\nV. Kesimpulan\n   A. Ringkasan poin kunci\n   B. Ajakan untuk eksplorasi lebih lanjut`;
                    
                    threadsContainer.innerHTML = `
                        <div class="thread-card">
                            <h4 class="mb-3">Outline Blog Post</h4>
                            <div class="prompt-item editable-content" contenteditable="true">${sampleOutlineText.replace(/\n/g, '<br>')}</div>
                            <button class="btn btn-sm btn-outline-primary mt-3" onclick="copyToClipboard(document.querySelector('.thread-card .prompt-item.editable-content').innerText)"><i class="bi bi-clipboard me-1"></i> Salin Outline</button>
                        </div>
                    `;
                    sampleMainContent = sampleOutlineText;
                    sampleImagePrompt = buildImagePromptFromBlogOutline(sampleOutlineText, topic, specificKeywordsInput.value.trim());

                } else if (selectedOutputFormat === 'caption') {
                    const sampleCaptionText = `Kecerdasan Buatan mengubah segalanya! Mulai dari cara kita bekerja hingga berinteraksi. Jangan ketinggalan era ini, pelajari dasar-dasarnya sekarang!\n\n#AI #MasaDepan #Teknologi`;
                    
                    threadsContainer.innerHTML = `
                        <div class="thread-card">
                            <h4 class="mb-3">Caption Singkat</h4>
                            <div class="prompt-item editable-content" contenteditable="true">${sampleCaptionText.replace(/\n/g, '<br>')}</div>
                            <button class="btn btn-sm btn-outline-primary mt-3" onclick="copyToClipboard(document.querySelector('.thread-card .prompt-item.editable-content').innerText)"><i class="bi bi-clipboard me-1"></i> Salin Caption</button>
                        </div>
                    `;
                    sampleMainContent = sampleCaptionText;
                    sampleImagePrompt = buildImagePromptFromCaption(sampleCaptionText, topic, specificKeywordsInput.value.trim());
                }

                imageGenPromptTextarea.value = sampleImagePrompt;
                imagePromptSection.style.display = 'block';
                renderPostingPreview(sampleMainContent, samplePrompts, ctaUsed, selectedOutputFormat);

                lastGeneratedSpan.textContent = new Date().toLocaleString('id-ID') + ' (Sample)';
            }

            // Load sample threads on page load
            generateSampleThreads(selectedTopic, null); // Pass null for ctaText to use default CTA initially

            // Simulate daily thread generation (for actual use, this would be a backend cron job)
            function simulateDailyGeneration() {
                const now = new Date();
                // Check if it's 7 AM WIB (UTC+7, so hour 0-23)
                // In a real scenario, this would be on a server, not client-side.
                // This client-side check is primarily for demonstration purposes within this single file.
                if (now.getHours() === 7 && now.getMinutes() === 0) {
                    const apiKey = localStorage.getItem('geminiApiKey');
                    if (apiKey) {
                        const params = {
                            topic: selectedTopic,
                            keywords: '', // Daily gen might use broader keywords
                            tone: 'informatif',
                            numTips: 7,
                            audience: 'umum',
                            outputFormat: 'thread',
                            customCta: null,
                        };
                        generateContentWithAPI(apiKey, params);
                    } else {
                        // Use default CTA text for sample generation
                        const defaultCta = `PS: Saya juga buka kelas AI untuk kamu yang benar-benar awam!\nKeunggulannya: setiap hari ada postingan tutorial terbaru, update terus.\nBelajar bisa kapan saja mulai jam 08.00 sampai 00.00 WIB.\nBebas belajar sampai bisa, sistem bayar per 10 hari.\nDan yang paling penting, harganya terjangkau dan disesuaikan.\nLangsung klik: https://lynk.id/vdmax`;
                        generateSampleThreads(selectedTopic, defaultCta);
                    }
                }
            }
            // setInterval(simulateDailyGeneration, 60000); // Commented out to avoid excessive sample regeneration during testing
        });
    </script>
</body>
</html>
